<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Platform</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GLOBALES MODERNIZADOS --- */
        :root {
            --primary: #6366f1; /* Indigo más vibrante */
            --primary-dark: #4338ca;
            --secondary: #0f172a; /* Slate dark */
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        .btn-primary { background-color: var(--primary); border-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .text-primary { color: var(--primary) !important; }
        .bg-surface { background-color: var(--bg-surface); }
        .shadow-soft { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025); }
        .card { border: 1px solid var(--border-color); box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); border-radius: 0.75rem; }

        /* LANDING STYLES */
        .hero-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #0f172a 100%);
            color: white;
            padding: 120px 0 100px;
            position: relative;
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .price-card {
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            transition: all 0.3s ease;
            background: var(--bg-surface);
        }
        .price-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.025); border-color: var(--primary); }
        .price-card.popular {
            background: var(--secondary);
            color: white;
            transform: scale(1.05);
            z-index: 10;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .price-card.popular h2, .price-card.popular h5, .price-card.popular .bi { color: white !important; }
        .price-card.popular .text-muted { color: #94a3b8 !important; }
        
        /* APP STYLES (COMMON) */
        .sidebar {
            min-height: 100vh;
            width: 280px;
            background: var(--secondary);
            color: #e2e8f0;
            position: fixed;
            top: 0; left: 0; z-index: 100;
            transition: margin 0.3s;
        }
        .sidebar .nav-link { color: #94a3b8; padding: 0.75rem 1rem; border-radius: 0.5rem; transition: 0.2s; margin-bottom: 0.25rem;}
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: rgba(255,255,255,0.1); }
        .sidebar .text-muted { color: #64748b !important; }
        
        .main-content { margin-left: 280px; padding: 40px; transition: margin 0.3s; width: calc(100% - 280px); }
        
        .stat-card {
            background: var(--bg-surface);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 1rem;
        }
        .stat-icon { width: 48px; height: 48px; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }

        /* SUPER ADMIN LAYOUT */
        .master-layout { display: flex; height: 100vh; overflow: hidden; background-color: #f1f5f9; }
        .sa-sidebar {
            width: 380px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            overflow-y: auto; z-index: 100;
        }
        .sa-content { flex: 1; overflow-y: auto; padding: 40px; }
        
        .company-item {
            padding: 1.25rem; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: 0.2s; border-left: 4px solid transparent;
        }
        .company-item:hover { background-color: var(--bg-body); }
        .company-item.active { background-color: #eef2ff; border-left-color: var(--primary); }

        /* UTILIDADES */
        .google-btn { background: white; border: 1px solid var(--border-color); color: var(--text-main); font-weight: 600; transition: 0.2s; }
        .google-btn:hover { background: var(--bg-body); border-color: #cbd5e1; }
        .badge-status-active { background-color: #10b98120; color: #059669; border: 1px solid #10b98150; }
        .badge-status-blocked { background-color: #ef444420; color: #dc2626; border: 1px solid #ef444450; }
        
        /* Responsive */
        @media (max-width: 991px) {
            .sidebar, .sa-sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .main-content, .sa-content { margin-left: 0; width: 100%; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="view-landing">
        <nav class="navbar navbar-expand-lg fixed-top glass-nav py-3">
            <div class="container">
                <a class="navbar-brand fw-bold text-primary fs-4 d-flex align-items-center" href="#">
                    <i class="bi bi-box-seam-fill me-2"></i>ArchiveMaster
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center gap-3">
                        <li class="nav-item"><a class="nav-link fw-medium" href="#pricing">Planes</a></li>
                        <li class="nav-item"><button onclick="window.showLoginModal()" class="btn btn-outline-primary rounded-pill px-4 fw-semibold me-2">Iniciar Sesión</button></li>
                        <li class="nav-item"><button onclick="document.getElementById('pricing').scrollIntoView({behavior:'smooth'})" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">Empezar Ahora</button></li>
                    </ul>
                </div>
            </div>
        </nav>

        <header class="hero-bg text-center">
            <div class="container mt-5 pt-5">
                <span class="badge bg-white bg-opacity-10 border border-white border-opacity-25 rounded-pill px-3 py-2 mb-4 fw-medium">✨ Nueva Versión 3.0 Enterprise</span>
                <h1 class="display-3 fw-bolder mb-4 lh-sm">Gestión de Insumos <br>Corporativos Simplificada</h1>
                <p class="lead text-white-50 mx-auto mb-5 fs-5" style="max-width: 650px;">Plataforma SaaS multi-tenant para el control total de inventarios, usuarios y logística en múltiples sedes.</p>
                <div class="d-flex justify-content-center gap-3">
                    <button onclick="document.getElementById('pricing').scrollIntoView({behavior:'smooth'})" class="btn btn-light btn-lg rounded-pill px-5 fw-bold text-primary shadow-lg">Ver Planes y Precios</button>
                </div>
            </div>
        </header>

        <section id="pricing" class="py-5 my-5">
            <div class="container py-5">
                <div class="text-center mb-5">
                    <h2 class="fw-bold display-6 mb-3">Planes Transparentes</h2>
                    <p class="text-muted fs-5">Escala tu operación sin costos ocultos.</p>
                </div>
                <div class="row justify-content-center g-4 align-items-center">
                    <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary mb-4">Basic</h5>
                            <h2 class="fw-bolder display-4 mb-0">$29<small class="fs-6 text-muted fw-medium">/mes</small></h2>
                            <ul class="list-unstyled text-start my-5 d-grid gap-3">
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> 1 Empresa / Sede</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> 5 Usuarios</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Inventario Básico</li>
                            </ul>
                            <button onclick="window.openRegisterModal('Basic')" class="btn btn-outline-primary w-100 rounded-pill fw-semibold py-2">Seleccionar Basic</button>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="card price-card popular p-5 text-center">
                            <span class="badge bg-primary text-white position-absolute top-0 start-50 translate-middle px-3 py-2 rounded-pill shadow-sm">MÁS ELEGIDO</span>
                            <h5 class="fw-bold mb-4">Pro Enterprise</h5>
                            <h2 class="fw-bolder display-4 mb-0">$79<small class="fs-6 text-white-50 fw-medium">/mes</small></h2>
                            <ul class="list-unstyled text-start my-5 d-grid gap-3">
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> <strong>Usuarios Ilimitados</strong></li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Multi-Sede (Hasta 3)</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Reportes Avanzados XLS</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Soporte Prioritario</li>
                            </ul>
                            <button onclick="window.openRegisterModal('Pro')" class="btn btn-primary w-100 rounded-pill fw-bold py-3 shadow">Comenzar Prueba Pro</button>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary mb-4">Business</h5>
                            <h2 class="fw-bolder display-4 mb-0">$199<small class="fs-6 text-muted fw-medium">/mes</small></h2>
                            <ul class="list-unstyled text-start my-5 d-grid gap-3">
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Sedes Ilimitadas</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> API Access</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Auditoría Completa</li>
                                <li><i class="bi bi-check-circle-fill text-primary me-2"></i> Gerente de Cuenta</li>
                            </ul>
                            <button onclick="window.openRegisterModal('Business')" class="btn btn-outline-secondary w-100 rounded-pill fw-semibold py-2">Contactar Ventas</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="view-company-setup" class="hidden min-vh-100 d-flex align-items-center justify-content-center bg-light">
        <div class="card shadow-lg border-0 rounded-4 p-5 text-center" style="max-width: 500px; width: 100%;">
            <div class="mb-4 text-primary">
                <i class="bi bi-building-check display-1"></i>
            </div>
            <h2 class="fw-bold mb-3">¡Pago Confirmado!</h2>
            <p class="text-muted mb-4">Gracias por tu suscripción. Solo falta un paso para acceder a tu panel.</p>
            
            <form id="setupCompanyForm" class="text-start">
                <div class="mb-4">
                    <label class="form-label fw-bold small">Nombre de tu Organización / Empresa</label>
                    <input type="text" id="setup-company-name" class="form-control form-control-lg" placeholder="Ej: Global Logistics Inc." required>
                    <input type="hidden" id="setup-plan-selected">
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg rounded-pill fw-bold shadow-sm">
                    Crear Panel Empresarial <i class="bi bi-arrow-right ms-2"></i>
                </button>
            </form>
            <div class="mt-4">
                <button onclick="window.logout()" class="btn btn-link text-muted text-decoration-none btn-sm">Cancelar y Salir</button>
            </div>
        </div>
    </div>


    <div id="view-super-admin" class="hidden master-layout">
        <div class="sa-sidebar shadow-sm">
            <div class="p-4 bg-surface border-bottom">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="fw-bold h5 mb-0 text-primary"><i class="bi bi-shield-lock-fill me-2"></i>MASTER ADMIN</span>
                    <button onclick="window.logout()" class="btn btn-sm btn-outline-secondary bg-white" title="Cerrar Sesión"><i class="bi bi-power"></i></button>
                </div>
                <button class="btn btn-outline-primary w-100 mb-3 fw-medium d-flex align-items-center justify-content-center gap-2" onclick="window.showCreateCompanyModal()">
                    <i class="bi bi-plus-circle-fill"></i> Registro Manual
                </button>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="sa-search" class="form-control border-start-0 ps-0" placeholder="Buscar empresa...">
                </div>
            </div>
            <div id="sa-company-list" class="bg-surface flex-grow-1">
                <div class="text-center p-5 text-muted small">Cargando listado...</div>
            </div>
        </div>

        <div class="sa-content">
            <div id="sa-empty-state" class="text-center mt-5 pt-5 text-muted opacity-50">
                <i class="bi bi-buildings display-1 mb-3 d-block"></i>
                <h3 class="fw-bold">Centro de Control SaaS</h3>
                <p class="fs-5">Selecciona una empresa del listado para gestionar su cuenta.</p>
            </div>

            <div id="sa-company-detail" class="hidden">
                <div class="d-flex justify-content-between align-items-start mb-5 p-4 bg-surface rounded-4 shadow-soft border">
                    <div>
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <h1 class="fw-bolder mb-0 text-secondary" id="sa-detail-name">Empresa</h1>
                            <button class="btn btn-sm btn-light border text-muted" onclick="window.openEditCompanyModal()" title="Editar Detalles"><i class="bi bi-pencil-fill"></i></button>
                        </div>
                        <div class="d-flex gap-2 align-items-center mb-3">
                             <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-3 py-2 rounded-pill" id="sa-detail-plan">Plan</span>
                             <span id="sa-detail-status" class="badge px-3 py-2 rounded-pill">Estado</span>
                        </div>
                        <ul class="list-unstyled text-muted small mb-0">
                            <li><i class="bi bi-key me-2"></i>ID: <span id="sa-detail-id" class="font-monospace"></span></li>
                            <li><i class="bi bi-person-circle me-2"></i>Admin Email: <span id="sa-detail-email" class="fw-medium text-dark"></span></li>
                            <li><i class="bi bi-calendar-event me-2"></i>Registrado: <span id="sa-detail-date"></span></li>
                        </ul>
                    </div>
                    <div class="d-flex gap-2 d-flex flex-column align-items-end">
                        <button id="sa-btn-block" class="btn btn-danger btn-lg w-100 fw-bold d-flex align-items-center gap-2 shadow-sm"><i class="bi bi-slash-circle"></i> Bloquear Acceso</button>
                    </div>
                </div>

                <div class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-people-fill"></i></div>
                            <div><h6 class="text-muted mb-1">Usuarios Totales</h6><h3 class="fw-bold mb-0" id="sa-stat-users">0</h3></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="stat-card">
                            <div class="stat-icon bg-success bg-opacity-10 text-success"><i class="bi bi-box-seam-fill"></i></div>
                            <div><h6 class="text-muted mb-1">Items en Inventario</h6><h3 class="fw-bold mb-0" id="sa-stat-items">0</h3></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                         <div class="stat-card">
                            <div class="stat-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-currency-dollar"></i></div>
                            <div><h6 class="text-muted mb-1">Pagos Registrados</h6><h3 class="fw-bold mb-0" id="sa-stat-rev">$0</h3></div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-soft overflow-hidden">
                    <div class="card-header bg-surface border-bottom p-0">
                        <ul class="nav nav-tabs nav-fill card-header-tabs m-0" id="saTabs">
                            <li class="nav-item"><a class="nav-link active py-3 fw-medium" data-bs-toggle="tab" href="#tab-sa-payments"><i class="bi bi-credit-card-2-front me-2"></i>Historial Pagos</a></li>
                            <li class="nav-item"><a class="nav-link py-3 fw-medium" data-bs-toggle="tab" href="#tab-sa-users"><i class="bi bi-person-badge me-2"></i>Directorio Usuarios</a></li>
                        </ul>
                    </div>
                    <div class="card-body p-4 bg-surface">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-sa-payments">
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="p-4 bg-body rounded-4 border">
                                            <h6 class="fw-bold mb-3">Registrar Pago Manual</h6>
                                            <form id="sa-payment-form">
                                                <div class="input-group mb-2">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" id="pay-amount" class="form-control" placeholder="Monto USD" required>
                                                </div>
                                                <select id="pay-method" class="form-select mb-3">
                                                    <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                                                    <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                                                    <option value="Efectivo">Efectivo / Otro</option>
                                                </select>
                                                <button type="submit" class="btn btn-success w-100 fw-bold">Registrar Ingreso</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="fw-bold mb-0">Transacciones Recientes</h6>
                                            <button onclick="window.downloadReportAdmin()" class="btn btn-sm btn-outline-secondary bg-white"><i class="bi bi-download me-1"></i> Exportar Todo</button>
                                        </div>
                                        
                                        <div class="table-responsive rounded-4 border">
                                            <table class="table table-hover align-middle mb-0 bg-surface">
                                                <thead class="bg-body small text-muted text-uppercase"><tr><th class="ps-4">Fecha</th><th>Monto</th><th>Método</th><th>Estado</th></tr></thead>
                                                <tbody id="sa-payments-table" class="fw-medium"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-sa-users">
                                <div class="table-responsive rounded-4 border">
                                    <table class="table table-hover align-middle mb-0 bg-surface">
                                        <thead class="bg-body small text-muted text-uppercase"><tr><th class="ps-4">Usuario</th><th>Email</th><th>Rol</th></tr></thead>
                                        <tbody id="sa-users-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-client-app" class="hidden">
        <div class="sidebar d-flex flex-column p-4 bg-secondary">
            <div class="mb-5 text-center">
                <div class="bg-white bg-opacity-10 text-white p-3 rounded-4 d-inline-block mb-3 shadow-sm"><i class="bi bi-buildings-fill fs-3"></i></div>
                <h6 class="fw-bold text-white mb-1" id="app-company-name">Cargando...</h6>
                <span class="badge bg-primary bg-opacity-25 text-primary-light border border-primary border-opacity-25 rounded-pill px-3">Panel Corporativo</span>
            </div>
            
            <ul class="nav nav-pills flex-column mb-auto gap-2 w-100">
                <li class="nav-item w-100">
                    <a href="#" onclick="window.showClientSection('dashboard')" class="nav-link active client-nav-link d-flex align-items-center" id="nav-c-dash">
                        <i class="bi bi-grid-1x2-fill me-3"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" onclick="window.showClientSection('users')" class="nav-link client-nav-link d-flex align-items-center" id="nav-c-users">
                        <i class="bi bi-people-fill me-3"></i> Equipo & Roles
                    </a>
                </li>
            </ul>
            <div class="mt-auto pt-4 border-top border-white border-opacity-10">
                <div class="d-flex align-items-center justify-content-between p-2 bg-white bg-opacity-5 rounded-3">
                    <div class="d-flex align-items-center gap-2 overflow-hidden">
                        <div class="bg-primary rounded-circle p-1 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;"><i class="bi bi-person-fill small text-white"></i></div>
                        <small class="text-muted text-truncate fw-medium" id="app-user-email" style="max-width: 140px;">user@mail.com</small>
                    </div>
                    <button onclick="window.logout()" class="btn btn-sm btn-outline-light border-0 text-muted hover-text-danger p-1" title="Cerrar Sesión"><i class="bi bi-box-arrow-right fs-6"></i></button>
                </div>
            </div>
        </div>

        <div class="main-content bg-body">
            
            <div id="client-section-dashboard">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-secondary mb-1">Inventario General</h2>
                         <p class="text-muted mb-0">Vista general del stock en tiempo real.</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="window.openAddItemModal()" class="btn btn-primary fw-bold shadow-sm"><i class="bi bi-plus-lg me-2 fw-bold"></i>Nuevo Insumo</button>
                        <button onclick="window.downloadReportClient()" class="btn btn-outline-secondary bg-surface shadow-sm fw-medium"><i class="bi bi-file-earmark-spreadsheet-fill me-2 text-success"></i>Exportar XLS</button>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-xl-4">
                        <div class="stat-card">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-box-seam-fill"></i></div>
                            <div><h6 class="text-muted mb-1">Total de Items</h6><h2 class="fw-bolder mb-0 text-secondary" id="client-stat-total">0</h2></div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-4">
                        <div class="stat-card border-danger">
                             <div class="stat-icon bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
                            <div><h6 class="text-muted mb-1">Stock Crítico</h6><h2 class="fw-bolder mb-0 text-danger" id="client-stat-low">0</h2></div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-soft overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 bg-surface">
                            <thead class="bg-body small text-muted text-uppercase"><tr><th class="ps-4 py-3">Nombre del Item</th><th>Categoría</th><th>Stock Actual</th><th>Estado</th></tr></thead>
                            <tbody id="client-inventory-table" class="fw-medium">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="client-section-users" class="hidden">
                 <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-secondary mb-1">Gestión de Equipo</h2>
                        <p class="text-muted mb-0">Administra el acceso y roles de tus colaboradores.</p>
                    </div>
                    <button onclick="window.openAddClientUserModal()" class="btn btn-primary fw-bold shadow-sm"><i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario</button>
                </div>

                <div class="card border-0 shadow-soft overflow-hidden">
                     <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 bg-surface">
                            <thead class="bg-body small text-muted text-uppercase"><tr><th class="ps-4 py-3">Nombre</th><th>Email Corporativo</th><th>Rol Asignado</th><th>Acciones</th></tr></thead>
                            <tbody id="client-users-table" class="fw-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-header border-0 pb-0 justify-content-center pt-4">
                     <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle mb-2"><i class="bi bi-person-circle fs-2"></i></div>
                </div>
                <div class="modal-body p-4 pt-0 text-center">
                    <h4 class="fw-bold mb-1">Bienvenido de nuevo</h4>
                    <p class="text-muted small mb-4">Accede a tu cuenta</p>
                    
                    <button id="btnGoogle" class="google-btn w-100 py-2p5 mb-3 rounded-3 d-flex align-items-center justify-content-center gap-3 shadow-sm fw-medium">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24"> Continuar con Google
                    </button>
                    
                    <div class="position-relative my-4 text-center">
                        <hr class="border-secondary border-opacity-10 position-absolute w-100 top-50 z-0">
                        <span class="bg-surface px-3 text-muted small position-relative z-1 fw-medium">o con tu email</span>
                    </div>

                    <form id="emailLoginForm" class="text-start">
                        <div class="form-floating mb-3">
                            <input type="email" id="loginEmail" class="form-control rounded-3 bg-body border-0" placeholder="name@example.com" required>
                            <label class="text-muted">Correo Electrónico</label>
                        </div>
                        <div class="form-floating mb-4">
                            <input type="password" id="loginPass" class="form-control rounded-3 bg-body border-0" placeholder="Password" required>
                            <label class="text-muted">Contraseña</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-3 shadow-sm">Iniciar Sesión</button>
                    </form>
                </div>
                 <div class="modal-footer justify-content-center border-0 bg-body py-3">
                    <small class="text-muted fw-medium">¿No tienes cuenta? <a href="#pricing" class="text-primary text-decoration-none fw-bold" onclick="bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide()">Regístrate</a></small>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="registerPayModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                 <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Crear Cuenta y Pagar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-primary d-flex align-items-center shadow-sm border-0 mb-4 rounded-3" role="alert">
                        <i class="bi bi-cart-check-fill fs-4 me-3"></i>
                        <div>Has seleccionado el <strong id="reg-plan-name">Plan X</strong>. <br><small>Completa tus datos para finalizar la suscripción.</small></div>
                    </div>

                    <form id="registerPayForm">
                        <h6 class="fw-bold text-muted mb-3 small text-uppercase">1. Datos del Administrador</h6>
                        <div class="row g-2 mb-4">
                             <div class="col-md-6">
                                <label class="form-label small fw-bold">Email Corporativo</label>
                                <input type="email" id="reg-email" class="form-control bg-body" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Contraseña</label>
                                <input type="password" id="reg-pass" class="form-control bg-body" minlength="6" required>
                            </div>
                        </div>

                         <h6 class="fw-bold text-muted mb-3 small text-uppercase d-flex justify-content-between">
                             <span>2. Método de Pago (Simulado)</span>
                             <span class="text-success"><i class="bi bi-shield-fill-check"></i> Seguro</span>
                         </h6>
                        <div class="bg-body p-3 rounded-3 border mb-4">
                             <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="payMethod" id="pm1" checked>
                                <label class="form-check-label d-flex align-items-center gap-2 fw-medium" for="pm1"><i class="bi bi-credit-card-2-front-fill text-primary"></i> Tarjeta de Crédito <small class="text-muted ms-auto">**** 4242</small></label>
                            </div>
                             <div class="form-check">
                                <input class="form-check-input" type="radio" name="payMethod" id="pm2">
                                <label class="form-check-label d-flex align-items-center gap-2 fw-medium" for="pm2"><i class="bi bi-paypal text-primary"></i> PayPal</label>
                            </div>
                        </div>
                        
                        <input type="hidden" id="reg-plan-selected">
                        <button type="submit" class="btn btn-success w-100 py-3 rounded-pill fw-bold shadow-sm btn-lg">
                            <i class="bi bi-lock-fill me-2"></i>Pagar y Registrarse
                        </button>
                        <div class="text-center mt-3"><small class="text-muted">Al continuar, aceptas los términos de servicio.</small></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 fw-bold"><h5 class="modal-title">Registro Manual de Empresa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="createCompanyForm">
                        <div class="mb-2"><label class="small fw-bold">Nombre Empresa</label><input type="text" id="cc-name" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Email Admin</label><input type="email" id="cc-email" class="form-control" required></div>
                        <div class="mb-3"><label class="small fw-bold">Contraseña Provicional</label><input type="text" id="cc-pass" class="form-control" minlength="6" required></div>
                        <div class="mb-4"><label class="small fw-bold">Plan Inicial</label><select id="cc-plan" class="form-select fw-medium"><option value="Basic">Basic</option><option value="Pro">Pro</option><option value="Business">Business</option></select></div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Crear Cliente</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="editCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 fw-bold"><h5 class="modal-title">Editar Detalles de Empresa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="editCompanyForm">
                        <input type="hidden" id="edit-company-id">
                        <div class="mb-3"><label class="small fw-bold">Nombre de la Empresa</label><input type="text" id="edit-c-name" class="form-control" required></div>
                        <div class="mb-4"><label class="small fw-bold">Plan Suscrito</label><select id="edit-c-plan" class="form-select fw-medium"><option value="Basic">Basic</option><option value="Pro">Pro</option><option value="Business">Business</option></select></div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalClientItem" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 fw-bold"><h5 class="modal-title">Agregar Nuevo Insumo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formClientItem">
                        <div class="mb-2"><label class="small fw-bold">Nombre del Item</label><input type="text" id="ci-name" class="form-control" required placeholder="Ej: Laptop Dell Latitude"></div>
                        <div class="mb-3"><label class="small fw-bold">Categoría</label><select id="ci-cat" class="form-select fw-medium"><option>Tecnología</option><option>Mobiliario</option><option>Papelería</option><option>Limpieza</option><option>EPP (Seguridad)</option><option>Otros</option></select></div>
                        <div class="mb-4"><label class="small fw-bold">Stock Inicial</label><input type="number" id="ci-stock" class="form-control" required min="0" placeholder="0"></div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Guardar en Inventario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalClientUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 fw-bold"><h5 class="modal-title">Registrar Nuevo Empleado</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formClientUser">
                        <div class="row g-2 mb-2">
                            <div class="col-md-6"><label class="small fw-bold">Nombre Completo</label><input type="text" id="cu-name" class="form-control" required></div>
                            <div class="col-md-6"><label class="small fw-bold">Email Corporativo</label><input type="email" id="cu-email" class="form-control" required></div>
                        </div>
                        <div class="mb-3"><label class="small fw-bold">Contraseña Temporal</label><input type="text" id="cu-pass" class="form-control" minlength="6" required placeholder="Mínimo 6 caracteres"></div>
                        <div class="mb-4"><label class="small fw-bold">Rol y Permisos</label>
                            <select id="cu-role" class="form-select fw-medium">
                                <option value="OPERADOR">Operador (Ver y Gestionar Stock)</option>
                                <option value="AUDITOR">Auditor (Acceso de Solo Lectura)</option>
                                <option value="COMPANY_ADMIN">Administrador (Control Total)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Crear Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy, serverTimestamp, getCountFromServer, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA5pUM_BycmKkbfhreDUrUH5CJEg_ykUW4",
            authDomain: "proyectocoorporativo.firebaseapp.com",
            projectId: "proyectocoorporativo",
            storageBucket: "proyectocoorporativo.firebasestorage.app",
            messagingSenderId: "152806986808",
            appId: "1:152806986808:web:6944d32424e27dbf9e82cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserData = null;
        let selectedCompanyId = null; // Para Super Admin
        let selectedCompanyData = null;

        // --- GESTIÓN DE VISTAS ---
        function showView(viewId) {
            document.querySelectorAll('body > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- AUTENTICACIÓN Y RUTEO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    // Ruteo basado en ROLES
                    if (currentUserData.role === 'SUPER_ADMIN') {
                        showView('view-super-admin');
                        initSuperAdminPanel();
                    } else if (currentUserData.role === 'PENDING_OWNER') {
                        // NUEVO: Flujo de configuración post-pago
                        showView('view-company-setup');
                        document.getElementById('setup-plan-selected').value = currentUserData.selectedPlan;
                    } else {
                        // Usuarios de Empresa (Admin, Operador, etc.)
                        const compSnap = await getDoc(doc(db, "companies", currentUserData.companyId));
                        if (compSnap.exists()) {
                            if (compSnap.data().status === 'blocked') {
                                alert("ACCESO DENEGADO: La cuenta de su empresa está suspendida.");
                                window.logout(); return;
                            }
                            showView('view-client-app');
                            initClientPanel(compSnap.data().name);
                        }
                    }
                } else { window.logout(); } // Usuario Auth sin doc en DB
            } else { showView('view-landing'); }
        });

        window.logout = () => signOut(auth).then(() => location.reload());
        window.showLoginModal = () => new bootstrap.Modal(document.getElementById('loginModal')).show();

        document.getElementById('btnGoogle').addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide(); } catch(e) { alert(e.message); }
        });
        document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } catch (e) { alert("Error: " + e.message); }
        });

        window.startDemo = () => {
            currentUserData = { role: 'DEMO', companyId: 'DEMO_CORP', email: 'demo@user.com' };
            showView('view-client-app');
            initClientPanel("Demo Corporation");
        };

        // ============================================
        // NUEVO FLUJO: REGISTRO -> PAGO -> CONFIGURACIÓN
        // ============================================
        
        // 1. Abrir modal de pago desde los botones de precios
        window.openRegisterModal = (planName) => {
            document.getElementById('reg-plan-name').innerText = "Plan " + planName;
            document.getElementById('reg-plan-selected').value = planName;
            new bootstrap.Modal(document.getElementById('registerPayModal')).show();
        };

        // 2. Procesar "Pago" y crear usuario PENDING
        document.getElementById('registerPayForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';
            
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const plan = document.getElementById('reg-plan-selected').value;

            try {
                // Crear usuario Auth
                const uCred = await createUserWithEmailAndPassword(auth, email, pass);
                // Crear doc en Firestore con rol PENDING
                await setDoc(doc(db, "users", uCred.user.uid), {
                    email: email,
                    role: 'PENDING_OWNER', // Rol temporal
                    selectedPlan: plan,
                    createdAt: serverTimestamp()
                });
                bootstrap.Modal.getInstance(document.getElementById('registerPayModal')).hide();
                // La redirección a 'view-company-setup' la hace el onAuthStateChanged automáticamente
            } catch (error) {
                alert("Error en registro: " + error.message);
                btn.disabled=false; btn.innerHTML = '<i class="bi bi-lock-fill me-2"></i>Pagar y Registrarse';
            }
        });

        // 3. Finalizar Configuración (Crear Empresa Real)
        document.getElementById('setupCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerText = "Configurando...";
            
            const companyName = document.getElementById('setup-company-name').value;
            const plan = document.getElementById('setup-plan-selected').value;
            const user = auth.currentUser;

            try {
                // A) Crear Empresa
                const compRef = await addDoc(collection(db, "companies"), {
                    name: companyName,
                    plan: plan,
                    status: 'active',
                    adminUid: user.uid, // Vincular al creador
                    createdAt: serverTimestamp()
                });

                // B) Actualizar usuario a COMPANY_ADMIN
                await updateDoc(doc(db, "users", user.uid), {
                    role: 'COMPANY_ADMIN',
                    companyId: compRef.id,
                    name: "Admin " + companyName,
                    selectedPlan: null // Ya no se necesita
                });
                // La redirección al panel final la hace el onAuthStateChanged
            } catch (error) {
                 alert("Error configurando empresa: " + error.message);
                 btn.disabled=false; btn.innerText = "Crear Panel Empresarial";
            }
        });


        // ============================================
        // LÓGICA SUPER ADMIN (MEJORADA)
        // ============================================
        window.showCreateCompanyModal = () => new bootstrap.Modal(document.getElementById('createCompanyModal')).show();
        window.openEditCompanyModal = () => {
             if(!selectedCompanyData) return;
             document.getElementById('edit-company-id').value = selectedCompanyData.id;
             document.getElementById('edit-c-name').value = selectedCompanyData.name;
             document.getElementById('edit-c-plan').value = selectedCompanyData.plan;
             new bootstrap.Modal(document.getElementById('editCompanyModal')).show();
        };


        // Editar Empresa (Nuevo)
        document.getElementById('editCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerText = "Guardando...";
            const compId = document.getElementById('edit-company-id').value;
            const newName = document.getElementById('edit-c-name').value;
            const newPlan = document.getElementById('edit-c-plan').value;
             try {
                await updateDoc(doc(db, "companies", compId), { name: newName, plan: newPlan });
                alert("Datos actualizados.");
                bootstrap.Modal.getInstance(document.getElementById('editCompanyModal')).hide();
                // Actualizar datos locales y UI
                selectedCompanyData.name = newName; selectedCompanyData.plan = newPlan;
                window.selectCompany(compId); // Refrescar detalles
                initSuperAdminPanel(); // Refrescar lista
            } catch(e) { alert(e.message); } finally { btn.disabled=false; btn.innerText="Guardar Cambios"; }
        });


        // Crear Empresa Manual (Mantenido por si acaso)
        document.getElementById('createCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true;
            try {
                const secApp = initializeApp(firebaseConfig, "Secondary");
                const secAuth = getAuth(secApp);
                const uCred = await createUserWithEmailAndPassword(secAuth, document.getElementById('cc-email').value, document.getElementById('cc-pass').value);
                await signOut(secAuth); 

                const compRef = await addDoc(collection(db, "companies"), {
                    name: document.getElementById('cc-name').value,
                    plan: document.getElementById('cc-plan').value,
                    status: 'active',
                    adminUid: uCred.user.uid,
                    createdAt: serverTimestamp()
                });

                await setDoc(doc(db, "users", uCred.user.uid), {
                    email: document.getElementById('cc-email').value,
                    role: 'COMPANY_ADMIN',
                    companyId: compRef.id,
                    name: "Admin " + document.getElementById('cc-name').value,
                    passHint: document.getElementById('cc-pass').value
                });

                alert("Empresa creada manualmente.");
                bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
                e.target.reset();
                initSuperAdminPanel();
            } catch(e) { alert(e.message); } finally { btn.disabled=false; }
        });

        async function initSuperAdminPanel() {
            const snap = await getDocs(collection(db, "companies"));
            const list = document.getElementById('sa-company-list');
            list.innerHTML = ""; window.allCompanies = [];
            snap.forEach(doc => {
                const d = doc.data();
                window.allCompanies.push({id: doc.id, ...d});
                const statusClass = d.status === 'active' ? 'badge-status-active' : 'badge-status-blocked';
                const statusText = d.status === 'active' ? 'Activo' : 'Bloqueado';
                 list.innerHTML += `<div class="company-item" onclick="window.selectCompany('${doc.id}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="fw-bold text-dark text-truncate" style="max-width: 200px;">${d.name}</div>
                         <small class="badge ${statusClass} rounded-pill px-2">${statusText}</small>
                    </div>
                    <small class="text-muted">${d.plan}</small>
                </div>`;
            });
        }

        window.selectCompany = async (id) => {
            selectedCompanyId = id;
            selectedCompanyData = window.allCompanies.find(c => c.id === id);
            document.getElementById('sa-empty-state').classList.add('hidden');
            document.getElementById('sa-company-detail').classList.remove('hidden');
            
            // Llenar detalles mejorados
            document.getElementById('sa-detail-name').innerText = selectedCompanyData.name;
            document.getElementById('sa-detail-id').innerText = id;
            document.getElementById('sa-detail-plan').innerText = selectedCompanyData.plan + " Plan";
            document.getElementById('sa-detail-date').innerText = selectedCompanyData.createdAt ? new Date(selectedCompanyData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            
            // Buscar email del admin
             let adminEmail = "No asignado";
             if(selectedCompanyData.adminUid) {
                 const adminSnap = await getDoc(doc(db, "users", selectedCompanyData.adminUid));
                 if(adminSnap.exists()) adminEmail = adminSnap.data().email;
             }
             document.getElementById('sa-detail-email').innerText = adminEmail;

            const badge = document.getElementById('sa-detail-status');
            const btnBlock = document.getElementById('sa-btn-block');
            
            if(selectedCompanyData.status === 'active') {
                badge.className = "badge badge-status-active px-3 py-2 rounded-pill"; badge.innerText = "Servicio Activo";
                btnBlock.className = "btn btn-danger btn-lg w-100 fw-bold d-flex align-items-center gap-2 shadow-sm"; btnBlock.innerHTML = '<i class="bi bi-slash-circle-fill"></i> Bloquear Acceso';
                btnBlock.onclick = () => toggleStatus(id, 'active');
            } else {
                badge.className = "badge badge-status-blocked px-3 py-2 rounded-pill"; badge.innerText = "Servicio Bloqueado";
                btnBlock.className = "btn btn-success btn-lg w-100 fw-bold d-flex align-items-center gap-2 shadow-sm"; btnBlock.innerHTML = '<i class="bi bi-check-circle-fill"></i> Reactivar Acceso';
                btnBlock.onclick = () => toggleStatus(id, 'blocked');
            }

            loadSAStats(id);
            loadSAUsers(id);
            loadSAPayments(id);
        };

        // (Funciones de carga SA auxiliares)
         async function toggleStatus(id, current) {
            if(!confirm("¿Cambiar estado de servicio de esta empresa?")) return;
            const newStatus = current === 'active' ? 'blocked' : 'active';
            await updateDoc(doc(db, "companies", id), { status: newStatus });
            selectedCompanyData.status = newStatus;
            window.selectCompany(id); 
            initSuperAdminPanel();
        }
        async function loadSAStats(id) {
             try {
                const sSupplies = await getCountFromServer(query(collection(db, `companies/${id}/supplies`)));
                const sUsers = await getCountFromServer(query(collection(db, "users"), where("companyId", "==", id)));
                document.getElementById('sa-stat-items').innerText = sSupplies.data().count;
                document.getElementById('sa-stat-users').innerText = sUsers.data().count;
            } catch(e) { console.log(e); document.getElementById('sa-stat-items').innerText='-';document.getElementById('sa-stat-users').innerText='-'; }
        }
        async function loadSAUsers(id) { 
            const snap = await getDocs(query(collection(db, "users"), where("companyId", "==", id)));
            const t = document.getElementById('sa-users-table'); t.innerHTML = "";
            snap.forEach(d => t.innerHTML += `<tr><td class="fw-medium ps-4">${d.data().name}</td><td>${d.data().email}</td><td><span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">${d.data().role}</span></td></tr>`);
        }
        async function loadSAPayments(id) {
             const snap = await getDocs(query(collection(db, `companies/${id}/payments`), orderBy("date", "desc")));
            let total = 0;
            const tbody = document.getElementById('sa-payments-table');
            tbody.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                total += p.amount;
                tbody.innerHTML += `<tr><td class="ps-4">${p.date ? new Date(p.date.seconds*1000).toLocaleDateString() : '-'}</td><td class="fw-bold text-success">+$${p.amount}</td><td>${p.method}</td><td><span class="badge bg-success bg-opacity-10 text-success">Completado</span></td></tr>`;
            });
            document.getElementById('sa-stat-rev').innerText = "$" + total;
        }

        // ============================================
        // LÓGICA CLIENTE (EMPRESA)
        // ============================================
        
        async function initClientPanel(companyName) {
            document.getElementById('app-company-name').innerText = companyName;
            document.getElementById('app-user-email').innerText = currentUserData?.email;
            
            // Si no es admin, ocultar el link de Usuarios
            if(currentUserData.role !== 'COMPANY_ADMIN') {
                document.getElementById('nav-c-users').classList.add('hidden');
            }

            loadClientInventory();
        }

        // --- NAVEGACIÓN CLIENTE ---
        window.showClientSection = (section) => {
            document.getElementById('client-section-dashboard').classList.add('hidden');
            document.getElementById('client-section-users').classList.add('hidden');
            document.querySelectorAll('.client-nav-link').forEach(l => l.classList.remove('active', 'bg-primary', 'text-white'));
            
            if(section === 'dashboard') {
                document.getElementById('client-section-dashboard').classList.remove('hidden');
                document.getElementById('nav-c-dash').classList.add('active', 'bg-primary', 'text-white');
                loadClientInventory();
            } else if(section === 'users') {
                document.getElementById('client-section-users').classList.remove('hidden');
                document.getElementById('nav-c-users').classList.add('active', 'bg-primary', 'text-white');
                loadClientUsers();
            }
        };

        // --- INVENTARIO ---
        window.openAddItemModal = () => new bootstrap.Modal(document.getElementById('modalClientItem')).show();

        document.getElementById('formClientItem').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(currentUserData.role === 'DEMO' || currentUserData.role === 'AUDITOR') return alert("Permiso denegado.");
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerText="Guardando...";
            try {
                await addDoc(collection(db, `companies/${currentUserData.companyId}/supplies`), {
                    name: document.getElementById('ci-name').value,
                    category: document.getElementById('ci-cat').value,
                    stock: parseInt(document.getElementById('ci-stock').value),
                    createdAt: serverTimestamp(),
                    createdBy: currentUserData.email
                });
                bootstrap.Modal.getInstance(document.getElementById('modalClientItem')).hide();
                e.target.reset();
                loadClientInventory();
            } catch(e){alert(e.message)} finally{btn.disabled=false; btn.innerText="Guardar en Inventario";}
        });

        async function loadClientInventory() {
            if(currentUserData.role === 'DEMO') { renderClientInventory([]); return; }
            const snap = await getDocs(collection(db, `companies/${currentUserData.companyId}/supplies`));
            let data = []; snap.forEach(d => data.push(d.data()));
            renderClientInventory(data);
        }

        function renderClientInventory(list) {
            const tbody = document.getElementById('client-inventory-table');
            tbody.innerHTML = ""; let low = 0; window.clientDataForExport = list;
            if(list.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Sin insumos registrados.</td></tr>'; }
            list.forEach(item => {
                if(item.stock < 5) low++;
                tbody.innerHTML += `<tr><td class="fw-bold ps-4">${item.name}</td><td><span class="badge bg-light text-dark border">${item.category}</span></td><td class="fw-bold">${item.stock}</td><td>${item.stock<5?'<span class="badge bg-danger bg-opacity-10 text-danger px-2 py-1">Stock Bajo</span>':'<span class="badge bg-success bg-opacity-10 text-success px-2 py-1">Óptimo</span>'}</td></tr>`;
            });
            document.getElementById('client-stat-total').innerText = list.length;
            document.getElementById('client-stat-low').innerText = low;
        }

        // --- GESTIÓN DE USUARIOS DE LA EMPRESA ---
        window.openAddClientUserModal = () => new bootstrap.Modal(document.getElementById('modalClientUser')).show();

        document.getElementById('formClientUser').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(currentUserData.role !== 'COMPANY_ADMIN') return alert("Acceso denegado: Solo administradores.");
            
            const btn = e.target.querySelector('button'); btn.disabled=true; btn.innerText = "Creando...";
            try {
                const secApp = initializeApp(firebaseConfig, "SecondaryClient");
                const secAuth = getAuth(secApp);
                const uCred = await createUserWithEmailAndPassword(secAuth, document.getElementById('cu-email').value, document.getElementById('cu-pass').value);
                await signOut(secAuth);

                await setDoc(doc(db, "users", uCred.user.uid), {
                    email: document.getElementById('cu-email').value,
                    name: document.getElementById('cu-name').value,
                    role: document.getElementById('cu-role').value,
                    companyId: currentUserData.companyId,
                    passHint: document.getElementById('cu-pass').value,
                    createdAt: serverTimestamp()
                });

                alert("Empleado creado exitosamente.");
                bootstrap.Modal.getInstance(document.getElementById('modalClientUser')).hide();
                e.target.reset();
                loadClientUsers();
            } catch(e) { alert("Error: " + e.message); } finally { btn.disabled=false; btn.innerText="Crear Usuario"; }
        });

        async function loadClientUsers() {
            if(currentUserData.role !== 'COMPANY_ADMIN') return;
            const snap = await getDocs(query(collection(db, "users"), where("companyId", "==", currentUserData.companyId)));
            const tbody = document.getElementById('client-users-table'); tbody.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                let roleBadge = u.role === 'COMPANY_ADMIN' ? 'bg-primary' : (u.role === 'OPERADOR' ? 'bg-info' : 'bg-secondary');
                tbody.innerHTML += `<tr><td class="fw-bold ps-4">${u.name}</td><td>${u.email}</td><td><span class="badge ${roleBadge} bg-opacity-25 text-dark border">${u.role}</span></td><td><button class="btn btn-sm btn-outline-secondary border-0 p-1" title="Editar (Próximamente)"><i class="bi bi-three-dots-vertical"></i></button></td></tr>`;
            });
        }

        // Exportar XLS Genérico
        window.downloadReportClient = () => { /* ...Misma función anterior... */ };
        window.downloadReportAdmin = () => { /* ...Misma función anterior... */ };

        // Buscador SA
        document.getElementById('sa-search').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.company-item').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(term) ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
