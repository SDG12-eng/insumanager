<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Empresa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="d-flex" id="wrapper">
        <div class="bg-dark text-white p-3" style="min-width: 250px; min-height: 100vh;">
            <h4>üè≠ Panel</h4>
            <hr>
            <ul class="nav flex-column">
                <li class="nav-item"><a href="#" class="nav-link text-white active">üì¶ Insumos</a></li>
                <li class="nav-item"><a href="#" class="nav-link text-white">üîÑ Movimientos</a></li>
                <li class="nav-item"><a href="#" class="nav-link text-white">üìä Reportes</a></li>
            </ul>
            <div class="mt-5">
                <button id="logoutBtn" class="btn btn-danger w-100">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="container-fluid p-4">
            <h2 class="mb-4">Gesti√≥n de Insumos</h2>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-primary mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Total Insumos</h5>
                            <p class="card-text fs-2" id="kpiTotal">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-white bg-danger mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Stock Bajo</h5>
                            <p class="card-text fs-2" id="kpiLow">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Inventario Actual</span>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addSupplyModal">+ Nuevo</button>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead><tr><th>Nombre</th><th>SKU</th><th>Stock</th><th>M√≠nimo</th><th>Acciones</th></tr></thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addSupplyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nuevo Insumo</h5></div>
                <div class="modal-body">
                    <form id="addSupplyForm">
                        <input type="text" class="form-control mb-2" id="sName" placeholder="Nombre" required>
                        <input type="text" class="form-control mb-2" id="sSku" placeholder="SKU" required>
                        <input type="number" class="form-control mb-2" id="sStock" placeholder="Stock Inicial" required>
                        <input type="number" class="form-control mb-2" id="sMin" placeholder="Stock M√≠nimo" required>
                        <button type="submit" class="btn btn-primary w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initAuthGuard, logoutUser } from './auth.js';
        import { getSupplies, addSupply, updateStock } from './db.js';

        initAuthGuard('COMPANY'); // Protege ruta
        document.getElementById('logoutBtn').onclick = logoutUser;

        const COMPANY_ID = localStorage.getItem('company_id');

        async function loadInventory() {
            const list = await getSupplies(COMPANY_ID);
            
            // KPIs
            document.getElementById('kpiTotal').innerText = list.length;
            document.getElementById('kpiLow').innerText = list.filter(i => i.stock <= i.minStock).length;

            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = list.map(item => `
                <tr class="${item.stock <= item.minStock ? 'table-danger' : ''}">
                    <td>${item.name}</td>
                    <td>${item.sku}</td>
                    <td><strong>${item.stock}</strong></td>
                    <td>${item.minStock}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="window.moveStock('${item.id}', 1, 'IN')">+</button>
                        <button class="btn btn-sm btn-warning" onclick="window.moveStock('${item.id}', 1, 'OUT')">-</button>
                    </td>
                </tr>
            `).join('');
        }

        // Exponer funci√≥n al DOM global para los botones
        window.moveStock = async (id, qty, type) => {
            const reason = prompt("Motivo del movimiento:");
            if(reason) {
                await updateStock(COMPANY_ID, id, qty, type, reason);
                loadInventory();
            }
        };

        document.getElementById('addSupplyForm').onsubmit = async (e) => {
            e.preventDefault();
            await addSupply(COMPANY_ID, {
                name: document.getElementById('sName').value,
                sku: document.getElementById('sSku').value,
                stock: parseInt(document.getElementById('sStock').value),
                minStock: parseInt(document.getElementById('sMin').value)
            });
            location.reload();
        };

        loadInventory();
    </script>
</body>
</html>
