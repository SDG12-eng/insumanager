<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Super Admin | SaaS Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark px-4">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è ADMIN MAESTRO SaaS</span>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Cerrar Sesi√≥n</button>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm p-3">
                    <h5>Nueva Empresa Cliente</h5>
                    <form id="createCompanyForm">
                        <input type="text" id="cName" class="form-control mb-2" placeholder="Nombre Empresa (Ej: FCI Logistic)" required>
                        <input type="email" id="cEmail" class="form-control mb-2" placeholder="Email Admin Empresa" required>
                        <select id="cPlan" class="form-select mb-3">
                            <option value="B√°sico">Plan B√°sico</option>
                            <option value="Pro">Plan Pro</option>
                            <option value="Enterprise">Plan Enterprise</option>
                        </select>
                        <button class="btn btn-success w-100">Registrar Empresa</button>
                    </form>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm p-3">
                    <h5>Gesti√≥n de Empresas & Pagos</h5>
                    <table class="table table-hover mt-3 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Empresa</th>
                                <th>Plan</th>
                                <th>Estado Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { authGuard, logout } from './auth.js';
        import { createCompany, getCompanies, toggleCompanyStatus } from './db.js';

        authGuard('SUPER_ADMIN');
        document.getElementById('logoutBtn').onclick = logout;

        async function loadCompanies() {
            const list = await getCompanies();
            const tbody = document.getElementById('companiesTable');
            tbody.innerHTML = list.map(c => `
                <tr class="${c.status === 'blocked' ? 'table-danger' : ''}">
                    <td class="fw-bold">${c.name}</td>
                    <td><span class="badge bg-info">${c.plan}</span></td>
                    <td>
                        ${c.status === 'active' 
                            ? '<span class="badge bg-success">AL D√çA</span>' 
                            : '<span class="badge bg-danger">MOROSO / BLOQUEADO</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-dark" onclick="alert('Gestionar Usuarios de ${c.name}')">Usuarios</button>
                        <button class="btn btn-sm ${c.status === 'active' ? 'btn-warning' : 'btn-success'}" 
                                onclick="window.toggleStatus('${c.id}', '${c.status}')">
                                ${c.status === 'active' ? 'Bloquear Servicio' : 'Reactivar'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.toggleStatus = async (id, status) => {
            if(confirm(`¬øEst√°s seguro de cambiar el estado de servicio?`)) {
                await toggleCompanyStatus(id, status);
                loadCompanies();
            }
        };

        document.getElementById('createCompanyForm').onsubmit = async (e) => {
            e.preventDefault();
            await createCompany({
                name: document.getElementById('cName').value,
                adminEmail: document.getElementById('cEmail').value,
                plan: document.getElementById('cPlan').value
            });
            alert("Empresa creada exitosamente");
            loadCompanies();
        };

        loadCompanies();
    </script>
</body>
</html>
