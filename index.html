<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveMaster | SaaS Platform</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GLOBALES --- */
        :root { --primary: #4f46e5; --secondary: #1e1b4b; --bg-light: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-light); overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* LANDING STYLES */
        .hero-bg { background: radial-gradient(circle at top right, #4f46e5 0%, #312e81 100%); color: white; padding: 100px 0; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .price-card { border-radius: 20px; border: none; transition: transform 0.3s; background: white; }
        .price-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .price-card.popular { background: #1e1b4b; color: white; transform: scale(1.05); z-index: 10; }
        
        /* APP STYLES (ADMIN & CLIENT) */
        .sidebar { min-height: 100vh; width: 260px; background: white; border-right: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; z-index: 100; transition: margin 0.3s; }
        .main-content { margin-left: 260px; padding: 30px; transition: margin 0.3s; width: calc(100% - 260px); }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        /* Super Admin Layout Especial */
        .master-layout { display: flex; height: 100vh; overflow: hidden; }
        .sa-sidebar { width: 350px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow-y: auto; z-index: 100; }
        .sa-content { flex: 1; background: #f3f4f6; overflow-y: auto; padding: 30px; }
        .company-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .company-item:hover { background-color: #f9fafb; }
        .company-item.active { background-color: #eef2ff; border-left: 4px solid var(--primary); }

        /* Utilidades */
        .google-btn { background: white; border: 1px solid #cbd5e1; color: #475569; font-weight: 600; transition: 0.2s; }
        .google-btn:hover { background: #f8fafc; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar, .sa-sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .main-content, .sa-content { margin-left: 0; width: 100%; }
            .sidebar.show, .sa-sidebar.show { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="view-landing">
        <nav class="navbar navbar-expand-lg fixed-top glass-nav py-3">
            <div class="container">
                <a class="navbar-brand fw-bold text-primary fs-4" href="#"><i class="bi bi-layers-half me-2"></i>ArchiveMaster</a>
                <div class="d-flex gap-2">
                    <button onclick="window.startDemo()" class="btn btn-outline-primary rounded-pill px-4 fw-bold">Demo</button>
                    <button onclick="window.showLoginModal()" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">Ingresar</button>
                </div>
            </div>
        </nav>

        <header class="hero-bg">
            <div class="container mt-5 text-center">
                <span class="badge bg-white bg-opacity-25 border border-white rounded-pill px-3 py-2 mb-3">v2.0 Enterprise Ready</span>
                <h1 class="display-3 fw-bolder mb-4">Gesti√≥n de Insumos Corporativos</h1>
                <p class="lead text-white-50 mx-auto mb-5" style="max-width: 700px;">Control total multi-sede. Automatiza inventarios, gestiona usuarios y exporta reportes financieros.</p>
                <button onclick="document.getElementById('pricing').scrollIntoView({behavior:'smooth'})" class="btn btn-light btn-lg rounded-pill px-5 fw-bold text-primary shadow">Ver Planes</button>
            </div>
        </header>

        <section id="pricing" class="py-5">
            <div class="container py-5">
                <div class="text-center mb-5"><h2 class="fw-bold">Planes Flexibles</h2></div>
                <div class="row justify-content-center g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary">Basic</h5>
                            <h2 class="fw-bold my-3">$10<small class="fs-6 text-muted">/mes</small></h2>
                            <ul class="list-unstyled text-start small mb-4">
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> 1 Empresa</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> 3 Usuarios</li>
                            </ul>
                            <button class="btn btn-outline-primary w-100 rounded-pill">Elegir</button>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="card price-card popular p-5 text-center">
                            <span class="badge bg-warning text-dark position-absolute top-0 start-50 translate-middle">POPULAR</span>
                            <h5 class="fw-bold">Pro</h5>
                            <h2 class="fw-bold my-3">$25<small class="fs-6 text-white-50">/mes</small></h2>
                            <ul class="list-unstyled text-start mb-4">
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Usuarios Ilimitados</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Reportes Excel</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Soporte Email</li>
                            </ul>
                            <button class="btn btn-light w-100 rounded-pill fw-bold text-primary">Empezar Ahora</button>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary">Business</h5>
                            <h2 class="fw-bold my-3">$40<small class="fs-6 text-muted">/mes</small></h2>
                            <ul class="list-unstyled text-start small mb-4">
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Multi-Sede</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Auditor√≠a</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Soporte VIP</li>
                            </ul>
                            <button class="btn btn-outline-dark w-100 rounded-pill">Elegir</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="py-5 bg-white text-center">
            <div class="container">
                <h3>Contacto Enterprise</h3>
                <p>Para grandes vol√∫menes, cont√°ctanos directamente.</p>
                <button class="btn btn-primary rounded-pill px-5">Contactar Ventas</button>
            </div>
        </section>
    </div>

    <div id="view-super-admin" class="hidden master-layout">
        <div class="sa-sidebar">
            <div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center sticky-top">
                <span class="fw-bold"><i class="bi bi-shield-lock"></i> MASTER ADMIN</span>
                <button onclick="window.logout()" class="btn btn-sm btn-outline-danger"><i class="bi bi-power"></i></button>
            </div>
            <div class="p-3 border-bottom bg-light">
                <button class="btn btn-primary w-100 mb-2 shadow-sm" onclick="window.showCreateCompanyModal()">
                    <i class="bi bi-plus-lg"></i> Nueva Empresa
                </button>
                <input type="text" id="sa-search" class="form-control form-control-sm" placeholder="Buscar cliente...">
            </div>
            <div id="sa-company-list">
                <div class="text-center p-4 text-muted small">Cargando empresas...</div>
            </div>
        </div>

        <div class="sa-content">
            <div id="sa-empty-state" class="text-center mt-5 pt-5 text-muted">
                <i class="bi bi-building display-1 opacity-25"></i>
                <h3 class="mt-3">Selecciona un cliente</h3>
                <p>Gestiona sus usuarios, pagos y estado de servicio.</p>
            </div>

            <div id="sa-company-detail" class="hidden">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h2 class="fw-bold mb-0" id="sa-detail-name">Empresa</h2>
                        <span class="badge bg-light text-dark border mt-1" id="sa-detail-id">ID</span>
                        <span class="badge bg-primary mt-1" id="sa-detail-plan">Plan</span>
                        <span id="sa-detail-status" class="badge mt-1">Estado</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="window.downloadReportAdmin()" class="btn btn-outline-dark"><i class="bi bi-file-earmark-excel"></i> Reporte XLS</button>
                        <button id="sa-btn-block" class="btn btn-danger"><i class="bi bi-slash-circle"></i> Bloquear</button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="stat-card border-start border-4 border-primary"><h6>Usuarios</h6><h3 id="sa-stat-users">0</h3></div></div>
                    <div class="col-md-4"><div class="stat-card border-start border-4 border-success"><h6>Insumos</h6><h3 id="sa-stat-items">0</h3></div></div>
                    <div class="col-md-4"><div class="stat-card border-start border-4 border-warning"><h6>Facturaci√≥n</h6><h3 id="sa-stat-rev">$0</h3></div></div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="saTabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-sa-payments">üí≥ Pagos</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-sa-users">üë• Usuarios</a></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-sa-payments">
                                <div class="row">
                                    <div class="col-md-4 border-end">
                                        <h6>Registrar Pago</h6>
                                        <form id="sa-payment-form">
                                            <input type="number" id="pay-amount" class="form-control mb-2" placeholder="Monto USD" required>
                                            <select id="pay-method" class="form-select mb-2">
                                                <option>Transferencia</option><option>Tarjeta</option><option>Efectivo</option>
                                            </select>
                                            <button type="submit" class="btn btn-success w-100">Guardar Pago</button>
                                        </form>
                                    </div>
                                    <div class="col-md-8 px-4">
                                        <h6>Historial</h6>
                                        <table class="table table-sm"><thead><tr><th>Fecha</th><th>Monto</th><th>M√©todo</th></tr></thead><tbody id="sa-payments-table"></tbody></table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-sa-users">
                                <table class="table table-hover"><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th></tr></thead><tbody id="sa-users-table"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-client-app" class="hidden">
        <div class="sidebar d-flex flex-column p-3">
            <div class="mb-4 text-center">
                <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle d-inline-block mb-2"><i class="bi bi-building fs-3"></i></div>
                <h6 class="fw-bold text-primary mb-0" id="app-company-name">Cargando...</h6>
                <small class="text-muted">Panel de Gesti√≥n</small>
            </div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item"><a href="#" class="nav-link active"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link text-dark"><i class="bi bi-box-seam me-2"></i> Inventario</a></li>
                <li><a href="#" class="nav-link text-dark"><i class="bi bi-arrow-left-right me-2"></i> Movimientos</a></li>
            </ul>
            <hr>
            <div class="d-flex align-items-center justify-content-between">
                <small class="text-muted text-truncate" id="app-user-email" style="max-width: 150px;">user@mail.com</small>
                <button onclick="window.logout()" class="btn btn-sm btn-outline-danger"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>

        <div class="main-content bg-light">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Inventario General</h3>
                <button onclick="window.downloadReportClient()" class="btn btn-success"><i class="bi bi-file-earmark-excel me-2"></i> Exportar XLS</button>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4"><div class="stat-card border-top border-4 border-info"><h6>Total Items</h6><h2 id="client-stat-total">0</h2></div></div>
                <div class="col-md-4"><div class="stat-card border-top border-4 border-danger"><h6>Stock Bajo</h6><h2 id="client-stat-low">0</h2></div></div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-primary" onclick="alert('Funcionalidad Demo: Crear Insumo')">+ Nuevo Insumo</button>
                    </div>
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>Nombre</th><th>Categor√≠a</th><th>Stock</th><th>Estado</th></tr></thead>
                        <tbody id="client-inventory-table">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-body p-5 text-center">
                    <h3 class="fw-bold mb-3">Bienvenido</h3>
                    <button id="btnGoogle" class="google-btn w-100 py-3 mb-3 rounded d-flex align-items-center justify-content-center gap-2">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Iniciar con Google
                    </button>
                    <div class="text-muted small mb-3">- O -</div>
                    <form id="emailLoginForm">
                        <input type="email" id="loginEmail" class="form-control mb-2 py-2" placeholder="Email" required>
                        <input type="password" id="loginPass" class="form-control mb-3 py-2" placeholder="Contrase√±a" required>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Entrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Registrar Empresa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="createCompanyForm">
                        <div class="mb-2"><label class="small fw-bold">Nombre Empresa</label><input type="text" id="cc-name" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Email Admin</label><input type="email" id="cc-email" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Contrase√±a</label><input type="text" id="cc-pass" class="form-control" minlength="6" required></div>
                        <div class="mb-3"><label class="small fw-bold">Plan</label><select id="cc-plan" class="form-select"><option value="Basic">Basic ($10)</option><option value="Pro">Pro ($25)</option><option value="Business">Business ($40)</option></select></div>
                        <button type="submit" class="btn btn-primary w-100">Crear Cliente</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // --- 1. FIREBASE CONFIG & INIT ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy, serverTimestamp, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURACI√ìN DE TU PROYECTO
        const firebaseConfig = {
            apiKey: "AIzaSyA5pUM_BycmKkbfhreDUrUH5CJEg_ykUW4",
            authDomain: "proyectocoorporativo.firebaseapp.com",
            projectId: "proyectocoorporativo",
            storageBucket: "proyectocoorporativo.firebasestorage.app",
            messagingSenderId: "152806986808",
            appId: "1:152806986808:web:6944d32424e27dbf9e82cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Estado Global
        let currentUserData = null;
        let selectedCompanyId = null;
        let selectedCompanyData = null;

        // --- 2. GESTI√ìN DE VISTAS (ROUTER) ---
        function showView(viewId) {
            document.querySelectorAll('body > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- 3. AUTENTICACI√ìN ---
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        
                        if (currentUserData.role === 'SUPER_ADMIN') {
                            showView('view-super-admin');
                            initSuperAdminPanel();
                        } else {
                            const compSnap = await getDoc(doc(db, "companies", currentUserData.companyId));
                            if (compSnap.exists()) {
                                if (compSnap.data().status === 'blocked') {
                                    alert("ACCESO DENEGADO: Cuenta suspendida.");
                                    window.logout();
                                    return;
                                }
                                showView('view-client-app');
                                initClientPanel(compSnap.data().name);
                            }
                        }
                    } else {
                        // Usuario no existe en DB, logout para evitar limbos
                        console.log("Usuario sin registro DB");
                        window.logout();
                    }
                } catch (e) { console.error(e); }
            } else {
                showView('view-landing');
            }
        });

        window.logout = () => signOut(auth).then(() => location.reload());
        window.showLoginModal = () => new bootstrap.Modal(document.getElementById('loginModal')).show();

        document.getElementById('btnGoogle').addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide(); } 
            catch (e) { alert(e.message); }
        });

        document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } catch (e) { alert("Error: " + e.message); }
        });

        window.startDemo = () => {
            // L√≥gica Demo sin redirecci√≥n externa
            currentUserData = { role: 'DEMO', companyId: 'DEMO_CORP', email: 'demo@user.com' };
            showView('view-client-app');
            initClientPanel("Demo Corporation");
        };

        // --- 4. L√ìGICA SUPER ADMIN ---

        window.showCreateCompanyModal = () => new bootstrap.Modal(document.getElementById('createCompanyModal')).show();

        document.getElementById('createCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Creando...";

            const name = document.getElementById('cc-name').value;
            const email = document.getElementById('cc-email').value;
            const pass = document.getElementById('cc-pass').value;
            const plan = document.getElementById('cc-plan').value;

            try {
                // Truco App Secundaria para no cerrar sesi√≥n al crear usuario
                const secApp = initializeApp(firebaseConfig, "Secondary");
                const secAuth = getAuth(secApp);
                const uCred = await createUserWithEmailAndPassword(secAuth, email, pass);
                await signOut(secAuth); 

                // Guardar en Firestore
                const compRef = await addDoc(collection(db, "companies"), { name, plan, status: 'active', createdAt: serverTimestamp() });
                await setDoc(doc(db, "users", uCred.user.uid), { email, role: 'COMPANY_ADMIN', companyId: compRef.id, name: "Admin " + name, passHint: pass });

                alert("Empresa creada con √©xito.");
                bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
                e.target.reset();
                initSuperAdminPanel();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false; btn.innerText = "Crear Cliente";
            }
        });

        async function initSuperAdminPanel() {
            const snap = await getDocs(collection(db, "companies"));
            const list = document.getElementById('sa-company-list');
            list.innerHTML = "";
            window.allCompanies = [];
            
            snap.forEach(doc => {
                const d = doc.data();
                window.allCompanies.push({id: doc.id, ...d});
                list.innerHTML += `
                    <div class="company-item d-flex justify-content-between align-items-center" onclick="window.selectCompany('${doc.id}')">
                        <div>
                            <div class="fw-bold">${d.name}</div>
                            <small class="text-muted">${d.plan} ‚Ä¢ <span class="badge ${d.status==='active'?'badge-status-active':'badge-status-blocked'} p-1 rounded-circle" style="width:10px;height:10px;display:inline-block"></span></small>
                        </div>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>`;
            });
        }

        window.selectCompany = async (id) => {
            selectedCompanyId = id;
            selectedCompanyData = window.allCompanies.find(c => c.id === id);
            
            document.getElementById('sa-empty-state').classList.add('hidden');
            document.getElementById('sa-company-detail').classList.remove('hidden');
            
            document.getElementById('sa-detail-name').innerText = selectedCompanyData.name;
            document.getElementById('sa-detail-id').innerText = "ID: " + id;
            document.getElementById('sa-detail-plan').innerText = selectedCompanyData.plan;
            
            const badge = document.getElementById('sa-detail-status');
            const btnBlock = document.getElementById('sa-btn-block');
            
            if(selectedCompanyData.status === 'active') {
                badge.className = "badge bg-success mt-1"; badge.innerText = "ACTIVO";
                btnBlock.className = "btn btn-danger"; btnBlock.innerHTML = '<i class="bi bi-slash-circle"></i> Bloquear';
                btnBlock.onclick = () => toggleStatus(id, 'active');
            } else {
                badge.className = "badge bg-danger mt-1"; badge.innerText = "BLOQUEADO";
                btnBlock.className = "btn btn-success"; btnBlock.innerHTML = '<i class="bi bi-check-circle"></i> Reactivar';
                btnBlock.onclick = () => toggleStatus(id, 'blocked');
            }

            loadCompanyStats(id);
            loadCompanyPayments(id);
            loadCompanyUsers(id);
        };

        async function toggleStatus(id, current) {
            if(!confirm("¬øCambiar estado de servicio?")) return;
            const newStatus = current === 'active' ? 'blocked' : 'active';
            await updateDoc(doc(db, "companies", id), { status: newStatus });
            selectedCompanyData.status = newStatus;
            window.selectCompany(id); 
            initSuperAdminPanel();
        }

        async function loadCompanyStats(id) {
            try {
                const sSupplies = await getCountFromServer(query(collection(db, `companies/${id}/supplies`)));
                const sUsers = await getCountFromServer(query(collection(db, "users"), where("companyId", "==", id)));
                document.getElementById('sa-stat-items').innerText = sSupplies.data().count;
                document.getElementById('sa-stat-users').innerText = sUsers.data().count;
            } catch(e) { console.log(e); }
        }

        async function loadCompanyPayments(id) {
            const snap = await getDocs(query(collection(db, `companies/${id}/payments`), orderBy("date", "desc")));
            let total = 0;
            const tbody = document.getElementById('sa-payments-table');
            tbody.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                total += p.amount;
                tbody.innerHTML += `<tr><td>${p.date ? new Date(p.date.seconds*1000).toLocaleDateString() : '-'}</td><td class="fw-bold text-success">$${p.amount}</td><td>${p.method}</td></tr>`;
            });
            document.getElementById('sa-stat-rev').innerText = "$" + total;
        }

        async function loadCompanyUsers(id) {
            const snap = await getDocs(query(collection(db, "users"), where("companyId", "==", id)));
            const tbody = document.getElementById('sa-users-table');
            tbody.innerHTML = "";
            snap.forEach(doc => {
                const u = doc.data();
                tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td><span class="badge bg-secondary">${u.role}</span><br><small class="text-muted">${u.passHint || ''}</small></td></tr>`;
            });
        }

        document.getElementById('sa-payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!selectedCompanyId) return;
            await addDoc(collection(db, `companies/${selectedCompanyId}/payments`), {
                amount: parseFloat(document.getElementById('pay-amount').value),
                method: document.getElementById('pay-method').value,
                date: serverTimestamp()
            });
            e.target.reset();
            loadCompanyPayments(selectedCompanyId);
            alert("Pago registrado");
        });

        window.downloadReportAdmin = async () => {
            if(!selectedCompanyId) return;
            const data = await getSuppliesData(selectedCompanyId);
            exportToExcel(data, `Reporte_${selectedCompanyData.name}`);
        };

        // --- 5. L√ìGICA CLIENTE ---

        async function initClientPanel(companyName) {
            document.getElementById('app-company-name').innerText = companyName;
            document.getElementById('app-user-email').innerText = currentUserData?.email || "demo@user.com";
            
            let data = [];
            if(currentUserData?.role === 'DEMO') {
                data = [{name:'Laptop Dell', category:'IT', stock:10}, {name:'Silla Erg', category:'Mobiliario', stock:2}];
            } else {
                data = await getSuppliesData(currentUserData.companyId);
            }
            renderClientInventory(data);
        }

        async function getSuppliesData(compId) {
            const snap = await getDocs(collection(db, `companies/${compId}/supplies`));
            return snap.docs.map(d => d.data());
        }

        function renderClientInventory(list) {
            const tbody = document.getElementById('client-inventory-table');
            tbody.innerHTML = "";
            let lowStock = 0;
            list.forEach(item => {
                if(item.stock < 5) lowStock++;
                tbody.innerHTML += `<tr><td class="fw-bold">${item.name}</td><td>${item.category}</td><td>${item.stock}</td><td>${item.stock < 5 ? '<span class="badge bg-danger">BAJO</span>' : '<span class="badge bg-success">OK</span>'}</td></tr>`;
            });
            document.getElementById('client-stat-total').innerText = list.length;
            document.getElementById('client-stat-low').innerText = lowStock;
            window.clientDataForExport = list;
        }

        window.downloadReportClient = () => {
            const name = currentUserData?.role === 'DEMO' ? 'DemoCorp' : document.getElementById('app-company-name').innerText;
            exportToExcel(window.clientDataForExport || [], `Inventario_${name}`);
        };

        function exportToExcel(data, filename) {
            let html = `<table border="1"><thead><tr style="background:#4f46e5;color:white"><th>Item</th><th>Cat</th><th>Stock</th></tr></thead><tbody>`;
            data.forEach(r => html += `<tr><td>${r.name}</td><td>${r.category}</td><td>${r.stock}</td></tr>`);
            html += `</tbody></table>`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([html], {type:'application/vnd.ms-excel'}));
            a.download = filename + '.xls';
            a.click();
        }

        document.getElementById('sa-search').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.company-item').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        });
    </script>
</body>
</html>
