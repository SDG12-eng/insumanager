<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Enterprise ERP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #2563eb; --secondary: #0f172a; --bg-body: #f1f5f9; --surface: #ffffff; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* Sidebar & Layout */
        .sidebar { width: 280px; height: 100vh; position: fixed; background: var(--secondary); color: white; overflow-y: auto; z-index: 1000; transition: 0.3s; }
        .main-content { margin-left: 280px; padding: 30px; width: calc(100% - 280px); transition: 0.3s; }
        
        .nav-link { color: #94a3b8; border-radius: 8px; margin-bottom: 4px; padding: 10px 15px; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: white; }
        .nav-group-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin: 20px 0 10px 15px; font-weight: 700; }

        /* Cards & UI */
        .card { border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-radius: 12px; }
        .stat-card { border-left: 4px solid var(--primary); }
        .btn { border-radius: 8px; font-weight: 500; }
        
        /* Form Builder Styles */
        .builder-field { border: 1px dashed #cbd5e1; padding: 15px; margin-bottom: 10px; background: #f8fafc; border-radius: 8px; position: relative; }
        .builder-field:hover { border-color: var(--primary); background: #fff; }
        .remove-field { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #ef4444; }
        
        /* Signature Canvas */
        canvas.sig-pad { border: 2px dashed #cbd5e1; border-radius: 8px; cursor: crosshair; background: #fff; width: 100%; }

        /* Landing */
        .hero-bg { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 100px 0; }
        
        @media(max-width: 992px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; width: 100%; }
            .sidebar.show { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="view-landing">
        <nav class="navbar navbar-expand-lg fixed-top bg-white border-bottom py-3">
            <div class="container">
                <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-grid-3x3-gap-fill me-2"></i>ArchiveMaster ERP</a>
                <div class="d-flex gap-2">
                    <button onclick="window.startDemo()" class="btn btn-outline-dark rounded-pill px-4">Demo</button>
                    <button onclick="window.showLoginModal()" class="btn btn-primary rounded-pill px-4">Ingresar</button>
                </div>
            </div>
        </nav>
        <header class="hero-bg text-center mt-5">
            <div class="container pt-5">
                <h1 class="display-4 fw-bold mb-4">Sistema Operativo Integral</h1>
                <p class="lead text-white-50 mx-auto mb-5" style="max-width: 700px;">Gesti贸n de Insumos, Activos, Tiquetes y Flujos de Trabajo en una sola plataforma multi-empresa.</p>
                <div class="row justify-content-center g-4 text-dark text-start mt-4">
                    <div class="col-md-3"><div class="card p-4 h-100"><h5> Inventario</h5><p class="small text-muted">Entradas, salidas y alertas de stock.</p></div></div>
                    <div class="col-md-3"><div class="card p-4 h-100"><h5> Formularios</h5><p class="small text-muted">Constructor din谩mico con firmas y fotos.</p></div></div>
                    <div class="col-md-3"><div class="card p-4 h-100"><h5> Tiquetes</h5><p class="small text-muted">Seguimiento de 贸rdenes de trabajo.</p></div></div>
                </div>
            </div>
        </header>
    </div>

    <div id="view-super-admin" class="hidden d-flex bg-light">
        <div class="sidebar p-3">
            <h5 class="mb-4 ps-2"><i class="bi bi-shield-lock me-2"></i>MASTER ADMIN</h5>
            <div class="nav flex-column">
                <a href="#" class="nav-link active"><i class="bi bi-buildings me-2"></i>Empresas</a>
                <a href="#" onclick="window.logout()" class="nav-link text-danger mt-auto"><i class="bi bi-power me-2"></i>Salir</a>
            </div>
        </div>
        <div class="main-content">
            <div class="d-flex justify-content-between mb-4">
                <h3>Gesti贸n de Clientes</h3>
                <button onclick="window.showCreateCompanyModal()" class="btn btn-primary">+ Nueva Empresa</button>
            </div>
            <div class="card p-0 overflow-hidden">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light"><tr><th class="ps-4">Empresa</th><th>Plan</th><th>Estado</th><th>Acciones</th></tr></thead>
                    <tbody id="sa-company-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-client-app" class="hidden">
        <div class="sidebar p-3 d-flex flex-column">
            <div class="mb-4 px-2">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <div class="bg-primary rounded p-1"><i class="bi bi-building text-white"></i></div>
                    <h6 class="mb-0 fw-bold text-white text-truncate" id="app-company-name">Empresa</h6>
                </div>
                <small class="text-muted" id="app-user-role">Rol: Cargando...</small>
            </div>

            <div class="nav flex-column mb-auto" id="app-menu">
                </div>

            <div class="mt-auto border-top pt-3 border-secondary">
                <div class="d-flex align-items-center justify-content-between px-2">
                    <small class="text-muted text-truncate" style="max-width: 150px;" id="app-user-email">user</small>
                    <button onclick="window.logout()" class="btn btn-sm btn-outline-danger border-0"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="sect-dashboard" class="app-section">
                <h3 class="fw-bold mb-4">Resumen Operativo</h3>
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="card p-3 stat-card"><h6>Tiquetes Abiertos</h6><h2 id="kpi-tickets">0</h2></div></div>
                    <div class="col-md-3"><div class="card p-3 stat-card" style="border-color: #10b981;"><h6>Stock Bajo</h6><h2 id="kpi-stock">0</h2></div></div>
                    <div class="col-md-3"><div class="card p-3 stat-card" style="border-color: #f59e0b;"><h6>Formularios Hoy</h6><h2 id="kpi-forms">0</h2></div></div>
                </div>
            </div>

            <div id="sect-users" class="app-section hidden">
                <div class="d-flex justify-content-between mb-4">
                    <h3>Usuarios y Accesos</h3>
                    <button onclick="window.openUserModal()" class="btn btn-primary">+ Nuevo Usuario</button>
                </div>
                <div class="card p-3">
                    <table class="table table-hover">
                        <thead><tr><th>Usuario</th><th>Email</th><th>Grupo/Rol</th><th>Acciones</th></tr></thead>
                        <tbody id="table-users"></tbody>
                    </table>
                </div>
            </div>

            <div id="sect-builder" class="app-section hidden">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <h5>Mis Formularios / Activos</h5>
                            <button onclick="window.initBuilderNew()" class="btn btn-outline-primary w-100 mb-3">+ Crear Nuevo Tipo</button>
                            <div class="list-group" id="list-modules"></div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="builder-canvas" class="card p-4 hidden">
                            <div class="d-flex justify-content-between mb-3">
                                <input type="text" id="b-form-name" class="form-control fw-bold" placeholder="Nombre del Formulario (ej: Inspecci贸n Vehicular)">
                                <button onclick="window.saveSchema()" class="btn btn-success">Guardar Estructura</button>
                            </div>
                            
                            <div class="card bg-light p-3 mb-3">
                                <h6>Configuraci贸n de Flujo</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="b-flow-ticket">
                                    <label class="form-check-label">Generar Tiquete de Seguimiento al enviar</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="b-flow-stock">
                                    <label class="form-check-label">Habilitar descuento de Stock (Inventario)</label>
                                </div>
                            </div>

                            <hr>
                            <div id="b-fields-container" class="mb-3"></div>
                            
                            <div class="d-flex gap-2">
                                <button onclick="window.addField('text')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-fonts"></i> Texto</button>
                                <button onclick="window.addField('number')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-123"></i> N煤mero</button>
                                <button onclick="window.addField('date')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-calendar"></i> Fecha</button>
                                <button onclick="window.addField('select')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-list-ul"></i> Selecci贸n</button>
                                <button onclick="window.addField('signature')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pen"></i> Firma</button>
                                <button onclick="window.addField('image')" class="btn btn-sm btn-outline-secondary"><i class="bi bi-image"></i> Foto</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sect-operations" class="app-section hidden">
                <div class="d-flex justify-content-between mb-3">
                    <h3 id="op-title">Registros</h3>
                    <div>
                        <button onclick="window.exportRecordsXLS()" class="btn btn-success me-2"><i class="bi bi-file-excel"></i> Exportar</button>
                        <button onclick="window.openNewRecordModal()" class="btn btn-primary">+ Nuevo Registro</button>
                    </div>
                </div>
                <div class="card p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light" id="op-table-head"></thead>
                            <tbody id="op-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sect-inventory" class="app-section hidden">
                <div class="d-flex justify-content-between mb-4">
                    <h3>Inventario de Insumos</h3>
                    <button onclick="window.openStockModal()" class="btn btn-primary">+ Agregar Item</button>
                </div>
                <div class="card p-0">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>SKU</th><th>Nombre</th><th>Stock</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody id="inv-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="sect-tickets" class="app-section hidden">
                <h3>Centro de Tiquetes</h3>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="card p-2 bg-light">
                            <h6 class="text-center">PENDIENTES</h6>
                            <div id="col-tickets-open" class="d-flex flex-column gap-2 p-2" style="min-height: 200px;"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-2 bg-light">
                            <h6 class="text-center">EN PROCESO</h6>
                            <div id="col-tickets-prog" class="d-flex flex-column gap-2 p-2" style="min-height: 200px;"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-2 bg-light">
                            <h6 class="text-center">RESUELTO</h6>
                            <div id="col-tickets-done" class="d-flex flex-column gap-2 p-2" style="min-height: 200px;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h4 class="text-center mb-3">Acceso Corporativo</h4><form id="loginForm"><input id="loginEmail" class="form-control mb-2" placeholder="Email"><input type="password" id="loginPass" class="form-control mb-3" placeholder="Password"><button class="btn btn-primary w-100">Entrar</button></form></div></div></div>

    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Nuevo Usuario</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="userForm"><input id="uName" class="form-control mb-2" placeholder="Nombre"><input id="uEmail" class="form-control mb-2" placeholder="Email"><input id="uPass" class="form-control mb-2" placeholder="Contrase帽a"><label>Grupo de Acceso</label><select id="uGroup" class="form-select"><option value="ADMIN">Administrador Total</option><option value="OPERACIONES">Operaciones (Inventario + Tiquetes)</option><option value="RRHH">Recursos Humanos (Formularios)</option></select><button class="btn btn-primary w-100 mt-3">Crear</button></form></div></div></div></div>

    <div class="modal fade" id="recordModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 id="rec-modal-title">Nuevo Registro</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="recordForm"><div id="rec-dynamic-fields"></div><div class="form-check mt-3"><input class="form-check-input" type="checkbox" id="rec-is-draft"><label class="form-check-label text-muted">Guardar como Borrador (No enviar)</label></div><button type="submit" class="btn btn-primary w-100 mt-3">Guardar Registro</button></form></div></div></div></div>

    <div class="modal fade" id="stockModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Item de Inventario</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="stockForm"><input id="stName" class="form-control mb-2" placeholder="Nombre Item"><input type="number" id="stQty" class="form-control mb-2" placeholder="Cantidad Inicial"><button class="btn btn-success w-100">Guardar</button></form></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, serverTimestamp, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5pUM_BycmKkbfhreDUrUH5CJEg_ykUW4",
            authDomain: "proyectocoorporativo.firebaseapp.com",
            projectId: "proyectocoorporativo",
            storageBucket: "proyectocoorporativo.firebasestorage.app",
            messagingSenderId: "152806986808",
            appId: "1:152806986808:web:6944d32424e27dbf9e82cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado
        let currentUser = null;
        let activeModuleSchema = null; // Esquema del formulario actual

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.role === 'SUPER_ADMIN') {
                        showView('view-super-admin');
                        loadSuperAdmin();
                    } else {
                        showView('view-client-app');
                        loadClientApp();
                    }
                }
            } else {
                showView('view-landing');
            }
        });

        window.login = async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } catch(e) { alert(e.message); }
        };
        document.getElementById('loginForm').onsubmit = window.login;
        window.logout = () => signOut(auth).then(()=>location.reload());
        window.showLoginModal = () => new bootstrap.Modal(document.getElementById('loginModal')).show();
        window.showView = (id) => { document.querySelectorAll('body > div[id^="view-"]').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }

        // --- CLIENT APP LOGIC ---

        async function loadClientApp() {
            // 1. Header Info
            const compSnap = await getDoc(doc(db, "companies", currentUser.companyId));
            document.getElementById('app-company-name').innerText = compSnap.data().name;
            document.getElementById('app-user-role').innerText = currentUser.role;
            document.getElementById('app-user-email').innerText = currentUser.email;

            // 2. Build Menu based on Role/Group
            const menu = document.getElementById('app-menu');
            menu.innerHTML = `<div class="nav-group-title">General</div>
                <a href="#" onclick="nav('dashboard')" class="nav-link active"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>`;
            
            // Si es Admin, ve configuraci贸n
            if(currentUser.role === 'COMPANY_ADMIN' || currentUser.group === 'ADMIN') {
                menu.innerHTML += `<div class="nav-group-title">Administraci贸n</div>
                <a href="#" onclick="nav('users')" class="nav-link"><i class="bi bi-people me-2"></i>Usuarios</a>
                <a href="#" onclick="nav('builder')" class="nav-link"><i class="bi bi-tools me-2"></i>Constructor</a>`;
            }

            // M贸dulos Din谩micos (Formularios creados)
            const schemas = await getDocs(collection(db, `companies/${currentUser.companyId}/schemas`));
            if(!schemas.empty) {
                menu.innerHTML += `<div class="nav-group-title">Operaciones</div>`;
                schemas.forEach(s => {
                    const sc = s.data();
                    menu.innerHTML += `<a href="#" onclick="loadModule('${s.id}')" class="nav-link"><i class="bi bi-journal-text me-2"></i>${sc.name}</a>`;
                });
            }

            menu.innerHTML += `<div class="nav-group-title">Log铆stica</div>
                <a href="#" onclick="nav('inventory')" class="nav-link"><i class="bi bi-box-seam me-2"></i>Inventario</a>
                <a href="#" onclick="nav('tickets')" class="nav-link"><i class="bi bi-ticket-detailed me-2"></i>Tiquetes</a>`;
            
            loadKPIs();
        }

        window.nav = (sect) => {
            document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`sect-${sect}`).classList.remove('hidden');
            if(sect === 'builder') loadBuilderList();
            if(sect === 'inventory') loadInventory();
            if(sect === 'tickets') loadTickets();
        };

        // --- FORM BUILDER (Constructor) ---
        let builderFields = [];
        
        window.loadBuilderList = async () => {
            const list = document.getElementById('list-modules');
            list.innerHTML = "";
            const snap = await getDocs(collection(db, `companies/${currentUser.companyId}/schemas`));
            snap.forEach(d => {
                list.innerHTML += `<a href="#" class="list-group-item list-group-item-action" onclick="alert('Edici贸n pendiente de implementar')">${d.data().name}</a>`;
            });
        };

        window.initBuilderNew = () => {
            builderFields = [];
            document.getElementById('b-form-name').value = "";
            document.getElementById('builder-canvas').classList.remove('hidden');
            renderBuilder();
        };

        window.addField = (type) => {
            builderFields.push({ type, label: 'Nuevo Campo', required: false, options: '' });
            renderBuilder();
        };

        function renderBuilder() {
            const c = document.getElementById('b-fields-container');
            c.innerHTML = "";
            builderFields.forEach((f, i) => {
                let extra = "";
                if(f.type === 'select') extra = `<input type="text" class="form-control form-control-sm mt-1" placeholder="Opciones separadas por coma" value="${f.options}" onchange="updateField(${i}, 'options', this.value)">`;
                
                c.innerHTML += `
                <div class="builder-field">
                    <i class="bi bi-x-circle remove-field" onclick="removeField(${i})"></i>
                    <div class="row g-2">
                        <div class="col-8">
                            <input type="text" class="form-control form-control-sm fw-bold" value="${f.label}" onchange="updateField(${i}, 'label', this.value)" placeholder="Etiqueta del Campo">
                        </div>
                        <div class="col-4 text-end">
                            <span class="badge bg-secondary">${f.type}</span>
                        </div>
                        <div class="col-12">${extra}</div>
                    </div>
                </div>`;
            });
        }
        window.removeField = (i) => { builderFields.splice(i, 1); renderBuilder(); };
        window.updateField = (i, k, v) => { builderFields[i][k] = v; };

        window.saveSchema = async () => {
            const name = document.getElementById('b-form-name').value;
            if(!name) return alert("Nombre requerido");
            
            await addDoc(collection(db, `companies/${currentUser.companyId}/schemas`), {
                name,
                fields: builderFields,
                genTicket: document.getElementById('b-flow-ticket').checked,
                useStock: document.getElementById('b-flow-stock').checked,
                createdAt: serverTimestamp()
            });
            alert("M贸dulo Creado");
            document.getElementById('builder-canvas').classList.add('hidden');
            loadClientApp(); // Recargar men煤
        };

        // --- OPERACIONES (Uso de M贸dulos) ---
        window.loadModule = async (schemaId) => {
            const snap = await getDoc(doc(db, `companies/${currentUser.companyId}/schemas`, schemaId));
            activeModuleSchema = { id: schemaId, ...snap.data() };
            
            document.getElementById('op-title').innerText = activeModuleSchema.name;
            
            // Tabla Headers
            let h = `<tr><th>Fecha</th><th>Usuario</th>`;
            activeModuleSchema.fields.slice(0, 3).forEach(f => h += `<th>${f.label}</th>`); // Mostrar primeros 3 campos
            h += `<th>Estado</th><th>Acciones</th></tr>`;
            document.getElementById('op-table-head').innerHTML = h;

            loadRecords();
            nav('operations');
        };

        async function loadRecords() {
            const snap = await getDocs(collection(db, `companies/${currentUser.companyId}/schemas/${activeModuleSchema.id}/records`));
            const t = document.getElementById('op-table-body');
            t.innerHTML = "";
            snap.forEach(d => {
                const r = d.data();
                let cols = `<td>${new Date(r.createdAt.seconds*1000).toLocaleDateString()}</td><td>${r.userName}</td>`;
                activeModuleSchema.fields.slice(0, 3).forEach(f => cols += `<td>${r.data[f.label] || '-'}</td>`);
                cols += `<td><span class="badge ${r.status==='draft'?'bg-warning':'bg-success'}">${r.status}</span></td><td><button class="btn btn-sm btn-light border">Ver</button></td>`;
                t.innerHTML += `<tr>${cols}</tr>`;
            });
        }

        window.openNewRecordModal = () => {
            document.getElementById('rec-modal-title').innerText = "Nuevo: " + activeModuleSchema.name;
            const c = document.getElementById('rec-dynamic-fields');
            c.innerHTML = "";
            
            activeModuleSchema.fields.forEach((f, i) => {
                let input = "";
                if(f.type === 'text') input = `<input class="form-control dyn-input" data-label="${f.label}">`;
                if(f.type === 'number') input = `<input type="number" class="form-control dyn-input" data-label="${f.label}">`;
                if(f.type === 'date') input = `<input type="date" class="form-control dyn-input" data-label="${f.label}">`;
                if(f.type === 'select') {
                    input = `<select class="form-select dyn-input" data-label="${f.label}">`;
                    f.options.split(',').forEach(o => input += `<option>${o.trim()}</option>`);
                    input += `</select>`;
                }
                if(f.type === 'signature') input = `<canvas class="sig-pad" id="sig-${i}" height="100"></canvas><input type="hidden" class="dyn-input" data-type="sig" data-id="sig-${i}" data-label="${f.label}">`;
                
                c.innerHTML += `<div class="mb-3"><label class="fw-bold small">${f.label}</label>${input}</div>`;
            });
            new bootstrap.Modal(document.getElementById('recordModal')).show();
        };

        document.getElementById('recordForm').onsubmit = async (e) => {
            e.preventDefault();
            let data = {};
            document.querySelectorAll('.dyn-input').forEach(el => {
                data[el.dataset.label] = el.value;
                // L贸gica de Canvas/Firma pendiente para brevedad (toDataURL)
            });

            const status = document.getElementById('rec-is-draft').checked ? 'draft' : 'submitted';

            // Guardar Registro
            const recRef = await addDoc(collection(db, `companies/${currentUser.companyId}/schemas/${activeModuleSchema.id}/records`), {
                data,
                status,
                userId: currentUser.uid || 'anon',
                userName: currentUser.name || 'Usuario',
                createdAt: serverTimestamp()
            });

            // Flujo: Crear Tiquete Autom谩tico
            if(status === 'submitted' && activeModuleSchema.genTicket) {
                await addDoc(collection(db, `companies/${currentUser.companyId}/tickets`), {
                    title: `Auto: ${activeModuleSchema.name} #${recRef.id.slice(0,4)}`,
                    status: 'OPEN',
                    sourceId: recRef.id,
                    createdAt: serverTimestamp()
                });
            }

            alert("Guardado");
            bootstrap.Modal.getInstance(document.getElementById('recordModal')).hide();
            loadRecords();
        };

        // --- INVENTARIO ---
        window.openStockModal = () => new bootstrap.Modal(document.getElementById('stockModal')).show();
        document.getElementById('stockForm').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, `companies/${currentUser.companyId}/supplies`), {
                name: document.getElementById('stName').value,
                stock: parseInt(document.getElementById('stQty').value)
            });
            bootstrap.Modal.getInstance(document.getElementById('stockModal')).hide();
            loadInventory();
        };
        async function loadInventory() {
            const s = await getDocs(collection(db, `companies/${currentUser.companyId}/supplies`));
            const t = document.getElementById('inv-table-body'); t.innerHTML = "";
            s.forEach(d => {
                const i = d.data();
                t.innerHTML += `<tr><td>${d.id.slice(0,6)}</td><td>${i.name}</td><td>${i.stock}</td><td>${i.stock<5?'<span class="badge bg-danger">Bajo</span>':'OK'}</td><td><button class="btn btn-sm btn-light">+</button></td></tr>`;
            });
        }

        // --- TIQUETES (KANBAN SIMPLE) ---
        async function loadTickets() {
            const s = await getDocs(collection(db, `companies/${currentUser.companyId}/tickets`));
            document.getElementById('col-tickets-open').innerHTML = "";
            document.getElementById('col-tickets-prog').innerHTML = "";
            document.getElementById('col-tickets-done').innerHTML = "";
            
            s.forEach(d => {
                const t = d.data();
                const card = `<div class="card p-2 shadow-sm border-start border-4 ${t.status==='OPEN'?'border-danger':(t.status==='WIP'?'border-primary':'border-success')}"><small class="fw-bold">${t.title}</small></div>`;
                
                if(t.status === 'OPEN') document.getElementById('col-tickets-open').innerHTML += card;
                if(t.status === 'WIP') document.getElementById('col-tickets-prog').innerHTML += card;
                if(t.status === 'DONE') document.getElementById('col-tickets-done').innerHTML += card;
            });
        }

        // --- DASHBOARD KPIS ---
        async function loadKPIs() {
            // Nota: En prod usar contadores. Aqu铆 lectura simple.
            const t = await getCountFromServer(collection(db, `companies/${currentUser.companyId}/tickets`));
            const f = 0; // Calcular logs hoy
            document.getElementById('kpi-tickets').innerText = t.data().count;
        }

        // --- GESTIN USUARIOS (Admin Empresa) ---
        window.openUserModal = () => new bootstrap.Modal(document.getElementById('userModal')).show();
        document.getElementById('userForm').onsubmit = async (e) => {
            e.preventDefault();
            // Truco App Secundaria para no cerrar sesi贸n
            const { initializeApp: init2 } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
            const { getAuth: auth2, createUserWithEmailAndPassword: create2, signOut: out2 } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
            
            const app2 = init2(firebaseConfig, "Secondary");
            const a2 = auth2(app2);
            const uc = await create2(a2, document.getElementById('uEmail').value, document.getElementById('uPass').value);
            await out2(a2);

            await setDoc(doc(db, "users", uc.user.uid), {
                name: document.getElementById('uName').value,
                email: document.getElementById('uEmail').value,
                role: 'USER',
                group: document.getElementById('uGroup').value,
                companyId: currentUser.companyId
            });
            alert("Usuario Creado");
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            loadUsersList();
        };

        async function loadUsersList() {
            const q = query(collection(db, "users"), where("companyId", "==", currentUser.companyId));
            const s = await getDocs(q);
            const t = document.getElementById('table-users'); t.innerHTML = "";
            s.forEach(d => {
                const u = d.data();
                t.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td><span class="badge bg-info">${u.group}</span></td><td><button class="btn btn-sm btn-light"><i class="bi bi-pencil"></i></button></td></tr>`;
            });
        }

        // --- SUPER ADMIN ---
        async function loadSuperAdmin() {
            const snap = await getDocs(collection(db, "companies"));
            const t = document.getElementById('sa-company-list'); t.innerHTML="";
            snap.forEach(d => {
                const c = d.data();
                t.innerHTML += `<tr><td>${c.name}</td><td>${c.plan}</td><td>${c.status}</td><td><button class="btn btn-sm btn-outline-dark">Gestionar</button></td></tr>`;
            });
        }

        window.showCreateCompanyModal = () => alert("Implementado en versi贸n anterior (reutilizar c贸digo)");

        // Helpers XLS
        window.exportRecordsXLS = () => {
            let html = document.querySelector('.table-responsive').innerHTML;
            const url = URL.createObjectURL(new Blob([html], {type:'application/vnd.ms-excel'}));
            const a = document.createElement('a'); a.href = url; a.download = 'Reporte.xls'; a.click();
        };

    </script>
</body>
</html>
