<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArchiveMaster | SaaS Platform</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS GLOBALES --- */
        :root { --primary: #4f46e5; --secondary: #1e1b4b; --bg-light: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-light); overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* LANDING STYLES */
        .hero-bg { background: radial-gradient(circle at top right, #4f46e5 0%, #312e81 100%); color: white; padding: 100px 0; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .price-card { border-radius: 20px; border: none; transition: transform 0.3s; background: white; }
        .price-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .price-card.popular { background: #1e1b4b; color: white; transform: scale(1.05); z-index: 10; }
        
        /* APP STYLES (ADMIN & CLIENT) */
        .sidebar { min-height: 100vh; width: 260px; background: white; border-right: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; z-index: 100; transition: margin 0.3s; }
        .main-content { margin-left: 260px; padding: 30px; transition: margin 0.3s; width: calc(100% - 260px); }
        .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        /* Super Admin Layout Especial */
        .master-layout { display: flex; height: 100vh; overflow: hidden; }
        .sa-sidebar { width: 350px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow-y: auto; z-index: 100; }
        .sa-content { flex: 1; background: #f3f4f6; overflow-y: auto; padding: 30px; }
        .company-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .company-item:hover { background-color: #f9fafb; }
        .company-item.active { background-color: #eef2ff; border-left: 4px solid var(--primary); }

        /* Utilidades */
        .google-btn { background: white; border: 1px solid #cbd5e1; color: #475569; font-weight: 600; transition: 0.2s; }
        .google-btn:hover { background: #f8fafc; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar, .sa-sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .main-content, .sa-content { margin-left: 0; width: 100%; }
            .sidebar.show, .sa-sidebar.show { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="view-landing">
        <nav class="navbar navbar-expand-lg fixed-top glass-nav py-3">
            <div class="container">
                <a class="navbar-brand fw-bold text-primary fs-4" href="#"><i class="bi bi-layers-half me-2"></i>ArchiveMaster</a>
                <div class="d-flex gap-2">
                    <button onclick="window.startDemo()" class="btn btn-outline-primary rounded-pill px-4 fw-bold">Demo</button>
                    <button onclick="window.showLoginModal()" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">Ingresar</button>
                </div>
            </div>
        </nav>

        <header class="hero-bg">
            <div class="container mt-5 text-center">
                <span class="badge bg-white bg-opacity-25 border border-white rounded-pill px-3 py-2 mb-3">v2.0 Enterprise Ready</span>
                <h1 class="display-3 fw-bolder mb-4">Gesti√≥n de Insumos Corporativos</h1>
                <p class="lead text-white-50 mx-auto mb-5" style="max-width: 700px;">Control total multi-sede. Automatiza inventarios, gestiona usuarios y exporta reportes financieros.</p>
                <button onclick="document.getElementById('pricing').scrollIntoView({behavior:'smooth'})" class="btn btn-light btn-lg rounded-pill px-5 fw-bold text-primary shadow">Ver Planes</button>
            </div>
        </header>

        <section id="pricing" class="py-5">
            <div class="container py-5">
                <div class="text-center mb-5"><h2 class="fw-bold">Planes Flexibles</h2></div>
                <div class="row justify-content-center g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary">Basic</h5>
                            <h2 class="fw-bold my-3">$10<small class="fs-6 text-muted">/mes</small></h2>
                            <ul class="list-unstyled text-start small mb-4">
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> 1 Empresa</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> 3 Usuarios</li>
                            </ul>
                            <button class="btn btn-outline-primary w-100 rounded-pill">Elegir</button>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="card price-card popular p-5 text-center">
                            <span class="badge bg-warning text-dark position-absolute top-0 start-50 translate-middle">POPULAR</span>
                            <h5 class="fw-bold">Pro</h5>
                            <h2 class="fw-bold my-3">$25<small class="fs-6 text-white-50">/mes</small></h2>
                            <ul class="list-unstyled text-start mb-4">
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Usuarios Ilimitados</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Reportes Excel</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-warning me-2"></i> Soporte Email</li>
                            </ul>
                            <button class="btn btn-light w-100 rounded-pill fw-bold text-primary">Empezar Ahora</button>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card price-card p-4 text-center h-100">
                            <h5 class="fw-bold text-secondary">Business</h5>
                            <h2 class="fw-bold my-3">$40<small class="fs-6 text-muted">/mes</small></h2>
                            <ul class="list-unstyled text-start small mb-4">
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Multi-Sede</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Auditor√≠a</li>
                                <li class="mb-2"><i class="bi bi-check text-primary"></i> Soporte VIP</li>
                            </ul>
                            <button class="btn btn-outline-dark w-100 rounded-pill">Elegir</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="view-super-admin" class="hidden master-layout">
        <div class="sa-sidebar">
            <div class="p-3 bg-dark text-white d-flex justify-content-between align-items-center sticky-top">
                <span class="fw-bold"><i class="bi bi-shield-lock"></i> MASTER ADMIN</span>
                <button onclick="window.logout()" class="btn btn-sm btn-outline-danger"><i class="bi bi-power"></i></button>
            </div>
            <div class="p-3 border-bottom bg-light">
                <button class="btn btn-primary w-100 mb-2 shadow-sm" onclick="window.showCreateCompanyModal()">
                    <i class="bi bi-plus-lg"></i> Nueva Empresa
                </button>
                <input type="text" id="sa-search" class="form-control form-control-sm" placeholder="Buscar cliente...">
            </div>
            <div id="sa-company-list">
                <div class="text-center p-4 text-muted small">Cargando empresas...</div>
            </div>
        </div>

        <div class="sa-content">
            <div id="sa-empty-state" class="text-center mt-5 pt-5 text-muted">
                <i class="bi bi-building display-1 opacity-25"></i>
                <h3 class="mt-3">Selecciona un cliente</h3>
                <p>Gestiona sus usuarios, pagos y estado de servicio.</p>
            </div>

            <div id="sa-company-detail" class="hidden">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h2 class="fw-bold mb-0" id="sa-detail-name">Empresa</h2>
                        <span class="badge bg-light text-dark border mt-1" id="sa-detail-id">ID</span>
                        <span class="badge bg-primary mt-1" id="sa-detail-plan">Plan</span>
                        <span id="sa-detail-status" class="badge mt-1">Estado</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="window.downloadReportAdmin()" class="btn btn-outline-dark"><i class="bi bi-file-earmark-excel"></i> Reporte XLS</button>
                        <button id="sa-btn-block" class="btn btn-danger"><i class="bi bi-slash-circle"></i> Bloquear</button>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="saTabs">
                            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-sa-payments">üí≥ Pagos</a></li>
                            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-sa-users">üë• Usuarios</a></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-sa-payments">
                                <div class="row">
                                    <div class="col-md-4 border-end">
                                        <h6>Registrar Pago</h6>
                                        <form id="sa-payment-form">
                                            <input type="number" id="pay-amount" class="form-control mb-2" placeholder="Monto USD" required>
                                            <select id="pay-method" class="form-select mb-2">
                                                <option>Transferencia</option><option>Tarjeta</option><option>Efectivo</option>
                                            </select>
                                            <button type="submit" class="btn btn-success w-100">Guardar Pago</button>
                                        </form>
                                    </div>
                                    <div class="col-md-8 px-4">
                                        <h6>Historial</h6>
                                        <table class="table table-sm"><thead><tr><th>Fecha</th><th>Monto</th><th>M√©todo</th></tr></thead><tbody id="sa-payments-table"></tbody></table>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="tab-sa-users">
                                <table class="table table-hover"><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th></tr></thead><tbody id="sa-users-table"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-client-app" class="hidden">
        <div class="sidebar d-flex flex-column p-3">
            <div class="mb-4 text-center">
                <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle d-inline-block mb-2"><i class="bi bi-building fs-3"></i></div>
                <h6 class="fw-bold text-primary mb-0" id="app-company-name">Cargando...</h6>
                <small class="text-muted">Panel de Gesti√≥n</small>
            </div>
            
            <ul class="nav nav-pills flex-column mb-auto gap-2">
                <li class="nav-item">
                    <a href="#" onclick="window.showClientSection('dashboard')" class="nav-link active client-nav-link" id="nav-c-dash">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" onclick="window.showClientSection('users')" class="nav-link text-dark client-nav-link" id="nav-c-users">
                        <i class="bi bi-people me-2"></i> Usuarios & Roles
                    </a>
                </li>
            </ul>
            <hr>
            <div class="d-flex align-items-center justify-content-between">
                <small class="text-muted text-truncate" id="app-user-email" style="max-width: 150px;">user@mail.com</small>
                <button onclick="window.logout()" class="btn btn-sm btn-outline-danger" title="Salir"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>

        <div class="main-content bg-light">
            
            <div id="client-section-dashboard">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold">Inventario General</h3>
                    <div class="d-flex gap-2">
                        <button onclick="window.openAddItemModal()" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> Nuevo Insumo</button>
                        <button onclick="window.downloadReportClient()" class="btn btn-success"><i class="bi bi-file-earmark-excel me-1"></i> Exportar XLS</button>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-4"><div class="stat-card border-top border-4 border-info"><h6>Total Items</h6><h2 id="client-stat-total">0</h2></div></div>
                    <div class="col-md-4"><div class="stat-card border-top border-4 border-danger"><h6>Stock Bajo</h6><h2 id="client-stat-low">0</h2></div></div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Nombre</th><th>Categor√≠a</th><th>Stock</th><th>Estado</th></tr></thead>
                            <tbody id="client-inventory-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="client-section-users" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold">Gesti√≥n de Empleados</h3>
                    <button onclick="window.openAddClientUserModal()" class="btn btn-primary"><i class="bi bi-person-plus me-1"></i> Nuevo Usuario</button>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <p class="text-muted small">Administra qui√©n tiene acceso a este panel.</p>
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>Nombre</th><th>Email</th><th>Rol / Permisos</th><th>Acciones</th></tr></thead>
                            <tbody id="client-users-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-body p-5 text-center">
                    <h3 class="fw-bold mb-3">Bienvenido</h3>
                    <button id="btnGoogle" class="google-btn w-100 py-3 mb-3 rounded d-flex align-items-center justify-content-center gap-2">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Iniciar con Google
                    </button>
                    <div class="text-muted small mb-3">- O -</div>
                    <form id="emailLoginForm">
                        <input type="email" id="loginEmail" class="form-control mb-2 py-2" placeholder="Email" required>
                        <input type="password" id="loginPass" class="form-control mb-3 py-2" placeholder="Contrase√±a" required>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold py-2">Entrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Registrar Empresa</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="createCompanyForm">
                        <div class="mb-2"><label class="small fw-bold">Nombre Empresa</label><input type="text" id="cc-name" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Email Admin</label><input type="email" id="cc-email" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Contrase√±a</label><input type="text" id="cc-pass" class="form-control" minlength="6" required></div>
                        <div class="mb-3"><label class="small fw-bold">Plan</label><select id="cc-plan" class="form-select"><option value="Basic">Basic ($10)</option><option value="Pro">Pro ($25)</option><option value="Business">Business ($40)</option></select></div>
                        <button type="submit" class="btn btn-primary w-100">Crear Cliente</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalClientItem" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nuevo Insumo</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formClientItem">
                        <div class="mb-2"><label class="small fw-bold">Nombre</label><input type="text" id="ci-name" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Categor√≠a</label><select id="ci-cat" class="form-select"><option>Oficina</option><option>Limpieza</option><option>Tecnolog√≠a</option><option>Seguridad</option></select></div>
                        <div class="mb-3"><label class="small fw-bold">Stock Inicial</label><input type="number" id="ci-stock" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalClientUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nuevo Empleado</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="formClientUser">
                        <div class="mb-2"><label class="small fw-bold">Nombre</label><input type="text" id="cu-name" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Email</label><input type="email" id="cu-email" class="form-control" required></div>
                        <div class="mb-2"><label class="small fw-bold">Contrase√±a</label><input type="text" id="cu-pass" class="form-control" minlength="6" required></div>
                        <div class="mb-3"><label class="small fw-bold">Rol</label>
                            <select id="cu-role" class="form-select">
                                <option value="OPERADOR">Operador (Ver y Mover Stock)</option>
                                <option value="AUDITOR">Auditor (Solo Ver)</option>
                                <option value="COMPANY_ADMIN">Admin (Control Total)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Crear Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, query, where, orderBy, serverTimestamp, getCountFromServer, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA5pUM_BycmKkbfhreDUrUH5CJEg_ykUW4",
            authDomain: "proyectocoorporativo.firebaseapp.com",
            projectId: "proyectocoorporativo",
            storageBucket: "proyectocoorporativo.firebasestorage.app",
            messagingSenderId: "152806986808",
            appId: "1:152806986808:web:6944d32424e27dbf9e82cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserData = null;
        let selectedCompanyId = null; // Para Super Admin
        let selectedCompanyData = null;

        // --- GESTI√ìN DE VISTAS ---
        function showView(viewId) {
            document.querySelectorAll('body > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- AUTENTICACI√ìN ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    if (currentUserData.role === 'SUPER_ADMIN') {
                        showView('view-super-admin');
                        initSuperAdminPanel();
                    } else {
                        // Validar Empresa
                        const compSnap = await getDoc(doc(db, "companies", currentUserData.companyId));
                        if (compSnap.exists()) {
                            if (compSnap.data().status === 'blocked') {
                                alert("ACCESO DENEGADO: Cuenta suspendida.");
                                window.logout(); return;
                            }
                            showView('view-client-app');
                            initClientPanel(compSnap.data().name);
                        }
                    }
                } else { window.logout(); }
            } else { showView('view-landing'); }
        });

        window.logout = () => signOut(auth).then(() => location.reload());
        window.showLoginModal = () => new bootstrap.Modal(document.getElementById('loginModal')).show();

        document.getElementById('btnGoogle').addEventListener('click', async () => {
            try { await signInWithPopup(auth, provider); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide(); } catch(e) { alert(e.message); }
        });
        document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            } catch (e) { alert("Error: " + e.message); }
        });

        window.startDemo = () => {
            currentUserData = { role: 'DEMO', companyId: 'DEMO_CORP', email: 'demo@user.com' };
            showView('view-client-app');
            initClientPanel("Demo Corporation");
        };

        // ============================================
        // L√ìGICA SUPER ADMIN
        // ============================================
        window.showCreateCompanyModal = () => new bootstrap.Modal(document.getElementById('createCompanyModal')).show();

        document.getElementById('createCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled=true;
            try {
                // Secondary App Trick para crear usuario sin desloguear admin
                const secApp = initializeApp(firebaseConfig, "Secondary");
                const secAuth = getAuth(secApp);
                const uCred = await createUserWithEmailAndPassword(secAuth, document.getElementById('cc-email').value, document.getElementById('cc-pass').value);
                await signOut(secAuth); 

                const compRef = await addDoc(collection(db, "companies"), {
                    name: document.getElementById('cc-name').value,
                    plan: document.getElementById('cc-plan').value,
                    status: 'active',
                    createdAt: serverTimestamp()
                });

                await setDoc(doc(db, "users", uCred.user.uid), {
                    email: document.getElementById('cc-email').value,
                    role: 'COMPANY_ADMIN',
                    companyId: compRef.id,
                    name: "Admin " + document.getElementById('cc-name').value,
                    passHint: document.getElementById('cc-pass').value
                });

                alert("Empresa creada.");
                bootstrap.Modal.getInstance(document.getElementById('createCompanyModal')).hide();
                e.target.reset();
                initSuperAdminPanel();
            } catch(e) { alert(e.message); } finally { btn.disabled=false; }
        });

        async function initSuperAdminPanel() {
            const snap = await getDocs(collection(db, "companies"));
            const list = document.getElementById('sa-company-list');
            list.innerHTML = ""; window.allCompanies = [];
            snap.forEach(doc => {
                const d = doc.data();
                window.allCompanies.push({id: doc.id, ...d});
                list.innerHTML += `<div class="company-item" onclick="window.selectCompany('${doc.id}')">
                    <div class="fw-bold">${d.name}</div><small class="text-muted">${d.plan} ‚Ä¢ ${d.status}</small></div>`;
            });
        }

        window.selectCompany = async (id) => {
            selectedCompanyId = id;
            selectedCompanyData = window.allCompanies.find(c => c.id === id);
            document.getElementById('sa-empty-state').classList.add('hidden');
            document.getElementById('sa-company-detail').classList.remove('hidden');
            document.getElementById('sa-detail-name').innerText = selectedCompanyData.name;
            document.getElementById('sa-detail-plan').innerText = selectedCompanyData.plan;
            
            // Cargar datos
            loadSAStats(id);
            loadSAUsers(id);
            loadSAPayments(id);
        };

        // (Funciones de carga SA simplificadas para brevedad, mismas que la versi√≥n anterior)
        async function loadSAStats(id) { /* ... */ }
        async function loadSAUsers(id) { 
            const snap = await getDocs(query(collection(db, "users"), where("companyId", "==", id)));
            const t = document.getElementById('sa-users-table'); t.innerHTML = "";
            snap.forEach(d => t.innerHTML += `<tr><td>${d.data().name}</td><td>${d.data().email}</td><td>${d.data().role}</td></tr>`);
        }
        async function loadSAPayments(id) { /* ... */ }

        // ============================================
        // L√ìGICA CLIENTE (EMPRESA)
        // ============================================
        
        async function initClientPanel(companyName) {
            document.getElementById('app-company-name').innerText = companyName;
            document.getElementById('app-user-email').innerText = currentUserData?.email;
            loadClientInventory();
        }

        // --- NAVEGACI√ìN CLIENTE ---
        window.showClientSection = (section) => {
            document.getElementById('client-section-dashboard').classList.add('hidden');
            document.getElementById('client-section-users').classList.add('hidden');
            document.querySelectorAll('.client-nav-link').forEach(l => l.classList.remove('active', 'text-primary'));
            
            if(section === 'dashboard') {
                document.getElementById('client-section-dashboard').classList.remove('hidden');
                document.getElementById('nav-c-dash').classList.add('active');
                loadClientInventory();
            } else if(section === 'users') {
                document.getElementById('client-section-users').classList.remove('hidden');
                document.getElementById('nav-c-users').classList.add('active');
                loadClientUsers();
            }
        };

        // --- INVENTARIO ---
        window.openAddItemModal = () => new bootstrap.Modal(document.getElementById('modalClientItem')).show();

        document.getElementById('formClientItem').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(currentUserData.role === 'DEMO') return alert("Modo Demo: No se guardan datos.");
            
            await addDoc(collection(db, `companies/${currentUserData.companyId}/supplies`), {
                name: document.getElementById('ci-name').value,
                category: document.getElementById('ci-cat').value,
                stock: parseInt(document.getElementById('ci-stock').value),
                createdAt: serverTimestamp()
            });
            bootstrap.Modal.getInstance(document.getElementById('modalClientItem')).hide();
            e.target.reset();
            loadClientInventory();
        });

        async function loadClientInventory() {
            if(currentUserData.role === 'DEMO') return; // Mock data logic optional
            const snap = await getDocs(collection(db, `companies/${currentUserData.companyId}/supplies`));
            const tbody = document.getElementById('client-inventory-table');
            tbody.innerHTML = "";
            let low = 0;
            
            window.clientDataForExport = [];
            snap.forEach(doc => {
                const d = doc.data();
                window.clientDataForExport.push(d);
                if(d.stock < 5) low++;
                tbody.innerHTML += `<tr><td class="fw-bold">${d.name}</td><td>${d.category}</td><td>${d.stock}</td><td>${d.stock<5?'<span class="badge bg-danger">BAJO</span>':'<span class="badge bg-success">OK</span>'}</td></tr>`;
            });
            document.getElementById('client-stat-total').innerText = snap.size;
            document.getElementById('client-stat-low').innerText = low;
        }

        // --- GESTI√ìN DE USUARIOS DE LA EMPRESA ---
        window.openAddClientUserModal = () => new bootstrap.Modal(document.getElementById('modalClientUser')).show();

        document.getElementById('formClientUser').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(currentUserData.role !== 'COMPANY_ADMIN') return alert("Solo el administrador puede crear usuarios.");
            
            const btn = e.target.querySelector('button'); btn.disabled=true;
            try {
                // Secondary App para crear empleado sin salir
                const secApp = initializeApp(firebaseConfig, "SecondaryClient");
                const secAuth = getAuth(secApp);
                const uCred = await createUserWithEmailAndPassword(secAuth, document.getElementById('cu-email').value, document.getElementById('cu-pass').value);
                await signOut(secAuth);

                await setDoc(doc(db, "users", uCred.user.uid), {
                    email: document.getElementById('cu-email').value,
                    name: document.getElementById('cu-name').value,
                    role: document.getElementById('cu-role').value,
                    companyId: currentUserData.companyId,
                    passHint: document.getElementById('cu-pass').value
                });

                alert("Empleado creado.");
                bootstrap.Modal.getInstance(document.getElementById('modalClientUser')).hide();
                e.target.reset();
                loadClientUsers();
            } catch(e) { alert(e.message); } finally { btn.disabled=false; }
        });

        async function loadClientUsers() {
            if(currentUserData.role === 'DEMO') return;
            const snap = await getDocs(query(collection(db, "users"), where("companyId", "==", currentUserData.companyId)));
            const tbody = document.getElementById('client-users-table');
            tbody.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td><span class="badge bg-secondary">${u.role}</span></td><td><button class="btn btn-sm btn-light border"><i class="bi bi-pencil"></i></button></td></tr>`;
            });
        }

        // Exportar XLS
        window.downloadReportClient = () => {
            const data = window.clientDataForExport || [];
            let html = `<table border="1"><thead><tr><th>Item</th><th>Cat</th><th>Stock</th></tr></thead><tbody>`;
            data.forEach(r => html += `<tr><td>${r.name}</td><td>${r.category}</td><td>${r.stock}</td></tr>`);
            html += `</tbody></table>`;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([html], {type:'application/vnd.ms-excel'}));
            a.download = `Inventario_${currentUserData.companyId}.xls`;
            a.click();
        };

    </script>
</body>
</html>
